<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat Phone UI</title>
    <!-- ÂºïÂÖ• FontAwesome ÂõæÊ†áÂ∫ì(Áî®‰∫éÊí≠ÊîæÂô®ÊåâÈíÆ) - ‰ΩøÁî®BootCDN -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.bootcdn.net/ajax/libs/boxicons/2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="CSS/widgets.css?v=2">
    <link rel="stylesheet" href="CSS/pages.css?v=2">
    <link rel="stylesheet" href="CSS/weixin.css">
    <link rel="stylesheet" href="CSS/global.css?v=2">
    <link rel="stylesheet" href="CSS/mine.css">
    <!-- Êñ∞Â¢ûÔºöÂºïÂÖ• manifest Ë∫´‰ªΩËØÅ -->
    <link rel="manifest" href="manifest.json">

    <!-- Êñ∞Â¢ûÔºöÈíàÂØπËãπÊûúÊâãÊú∫ÁöÑÁâπÊÆä‰ºòÂæÖÔºàËãπÊûú‰∏çËØª manifestÔºåÂÆÉÁúãËøô‰∏™Ôºâ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- 3. ËÅäÂ§©ÂÆ§‰∏ìÁî®Ê†∑Âºè (Êñ∞Â¢ûËøô‰∏™) -->
    <link rel="stylesheet" href="CSS/chat-page.css">
    <style>
        /* Âº∫Âà∂ÁªôÂºπÁ™óÂä†ÊªöÂä®Êù°ÔºåÈò≤Ê≠¢ÂÜÖÂÆπÂ§™ÈïøÁúã‰∏çËßÅÊåâÈíÆ */
        .creator-body {
            max-height: 60vh !important;
            /* ÈôêÂà∂È´òÂ∫¶ */
            overflow-y: auto !important;
            /* ÂÖÅËÆ∏‰∏ä‰∏ãÊªöÂä® */
            padding-bottom: 50px !important;
            /* Â∫ïÈÉ®ÁïôÂá∫Á©∫Èöô */
        }

        /* === Âº∫Âà∂Â±ÇÁ∫ß‰øÆÂ§çË°•‰∏Å === */
        /* 1. ËÆ©ËÅäÂ§©Â§ßÁõíÂ≠êÈì∫Êª°Â±èÂπïÔºå‰ΩÜÊ≤°Êúâ‰ªª‰ΩïËæπÊ°Ü */
        #chat-view {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            /* ÊØîÊ°åÈù¢È´ò */
            background: #fff;
            overflow: hidden;
            /* Èò≤Ê≠¢Ê∫¢Âá∫ */
        }

        /* 2. ËÆ©ÂºπÁ™óÊ∞∏ËøúÂú®ÊúÄÊúÄÊúÄÈ°∂Â±Ç */
        .modal-layer {
            z-index: 9999 !important;
            /* ÂøÖÈ°ªÊØî chat-view È´ò */
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* === ‰øÆÂ§çÂºπÁ™óÂ±ÇÁ∫ßÊâìÊû∂ÁöÑÈóÆÈ¢ò === */
        /* 1. ËÆ©ËÆæÁΩÆËèúÂçïÁ®çÂæÆ‰Ωé‰∏ÄÁÇπ */
        #settings-menu-modal {
            z-index: 9000 !important;
        }

        /* 2. ËÆ©ÂäüËÉΩÂºπÁ™óÔºàÁºñËæë„ÄÅË∫´‰ªΩ„ÄÅËÉåÊôØÔºâÊ∞∏ËøúÂéãÂú®ËèúÂçï‰∏äÈù¢ */
        #creator-modal,
        #user-persona-modal,
        #bg-setting-modal {
            z-index: 10000 !important;
        }

        /* === ÂºπÁ™óÈ°∂ÈÉ®Ê†è‰ºòÂåñ (ÁÆ≠Â§¥Èù†Â∑¶) === */
        .modal-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 50px;
            padding: 40px 10px 0 10px;
            box-sizing: border-box;
        }

        /* Â∑¶‰æßËøîÂõûÊåâÈíÆ */
        .modal-close-icon {
            width: 60px;
            /* ÁªôÂÆöÂÆΩÂ∫¶ */
            text-align: left;
            /* Âº∫Âà∂Èù†Â∑¶ */
            font-size: 32px;
            /* Â≠ó‰ΩìÊîæÂ§ßÁÇπ */
            line-height: 1;
            cursor: pointer;
            padding-left: 10px;
            /* ÂÜçÂæÄÈáå‰∏ÄÁÇπÁÇπ */
        }

        /* ‰∏≠Èó¥Ê†áÈ¢ò */
        .modal-title {
            flex: 1;
            /* Âç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ */
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        /* Âè≥‰æßÂç†‰ΩçÁ¨¶ (‰∏∫‰∫ÜËÆ©Ê†áÈ¢òÁªùÂØπÂ±Ö‰∏≠) */
        .modal-placeholder {
            width: 60px;
            /* ÂøÖÈ°ªÂíåÂ∑¶‰æßÂõæÊ†áÂÆΩÂ∫¶‰∏ÄÊ†∑ */
        }
    </style>

</head>

<body>

    <!-- ÂºÄÂ±èÂä®ÁîªÂ±Ç -->
    <div id="splash-screen" class="splash-screen">
        <img src="assets/icons/splash-screen.png" alt="Shubao Phone" class="splash-logo">
    </div>

    <div class="phone-frame">
        <div class="screen">
            <div class="notch"></div>

            <!-- --- ÊµÆÂä®Â±ÇÔºöÁä∂ÊÄÅÊ†è (‰øùÊåÅ‰∏çÂä®) --- -->
            <div class="status-bar">
                <div class="status-time" id="status-time-text">--:--</div>
                <div class="battery-icon">
                    <span class="battery-level" id="battery-num">--</span>
                </div>
            </div>
            <!-- ========== „ÄêÊ°åÈù¢Â§ßÁõíÂ≠êÂºÄÂßã„Äë ========== -->
            <div id="desktop-view">

                <div class="desktop-layout">

                    <!-- Á¨¨‰∏ÄÊéíÔºöÁªü‰∏ÄÁöÑÂ§ßÁÅ∞ÁõíÂ≠ê -->
                    <section class="desktop-section desktop-top" style="padding: 0; background: transparent;">

                        <!-- ËøôÊòØ‰∏Ä‰∏™Â§ßÁöÑÁÅ∞Ëâ≤ÂÆπÂô®ÔºåÁî®Êù•ÂåÖË£πÈáåÈù¢ÁöÑË¥¥Á∫∏ÂíåËÅäÂ§©Ê°Ü -->
                        <div class="top-unified-container">

                            <!-- Â∑¶‰æßÔºöÈáçÂè†ÁÖßÁâáÂå∫ -->
                            <div class="top-left-stickers">
                                <!-- ÁÖßÁâá 1 (ÂêéÂ±Ç) -->
                                <div class="sticker-card sticker-back" onclick="triggerWidgetUpload('sticker-1')">
                                    <img id="img-sticker-1" src="assets/icons/icon-placeholder.png" style="opacity:0;">
                                    <!-- ÈªòËÆ§ÈÄèÊòéÔºå‰∏ä‰º†ÂêéÊòæÁ§∫ -->
                                    <div class="upload-hint-text">ÁÖßÁâá1</div>
                                </div>

                                <!-- ÁÖßÁâá 2 (ÂâçÂ±ÇÔºåÂéã‰Ωè‰∏äÈù¢ÈÇ£‰∏™) -->
                                <div class="sticker-card sticker-front" onclick="triggerWidgetUpload('sticker-2')">
                                    <img id="img-sticker-2" src="assets/icons/icon-placeholder.png" style="opacity:0;">
                                    <div class="upload-hint-text">ÁÖßÁâá2</div>
                                </div>
                            </div>

                            <!-- Âè≥‰æßÔºöËÅäÂ§©/Â§ßÂõæÂå∫ -->
                            <div class="top-right-chat-card" onclick="triggerWidgetUpload('top-right-banner')">
                                <img id="img-top-right-banner" src="assets/icons/icon-placeholder.png"
                                    style="opacity:0;">
                                <div class="upload-hint-text">ÁÇπÂáª‰∏ä‰º†<br>ËÅäÂ§©Êà™Âõæ</div>
                            </div>

                        </div>
                    </section>


                    <!-- =========================================================
         Á¨¨‰∫åË°åÔºöÂ∑¶‰æß(4‰∏™APP) + Âè≥‰æß(INSÈ£éÂç°Áâá - Â∑≤‰øÆÂ§çÁªìÊûÑ)
         ========================================================= -->
                    <section class="desktop-section desktop-middle">
                        <div class="desktop-middle-left">
                            <div class="app-grid-2x2">
                                <div class="app-item-small" id="app-item-0"
                                    onclick="openChatApp(); document.getElementById('top-plus-btn').style.display='block'">
                                    <i id="app-icon-0" class="fas fa-comment"></i>
                                    <span id="app-name-0" class="app-icon-text">ÂæÆ‰ø°</span>
                                </div>
                                <div class="app-item-small" id="app-item-1" onclick="openWorldBookApp()">
                                    <i id="app-icon-1" class="fas fa-book"></i>
                                    <span id="app-name-1" class="app-icon-text">‰∏ñÁïå‰π¶</span>
                                </div>
                                <div class="app-item-small" id="app-item-2">
                                    <i id="app-icon-2" class="fas fa-music"></i>
                                    <span id="app-name-2" class="app-icon-text">Èü≥‰πê</span>
                                </div>
                                <div class="app-item-small" id="app-item-3">
                                    <i id="app-icon-3" class="fas fa-hashtag"></i>
                                    <span id="app-name-3" class="app-icon-text">Â∞èÁ∫¢‰π¶</span>
                                </div>
                            </div>
                        </div>

                        <div class="desktop-middle-right">
                            <!-- INSÈ£é Ê∞õÂõ¥ÊÑüÂç°Áâá (ÁªìÊûÑ‰øÆÂ§çÁâà) -->
                            <div class="aesthetic-card">

                                <!-- 0. ËÉåÊôØÂõæÂ±Ç -->
                                <img id="img-aesthetic-bg" class="aes-bg-img" src="assets/icons/icon-placeholder.png"
                                    onclick="triggerWidgetUpload('aesthetic-bg')" style="opacity: 0;">

                                <!-- 1. È°∂ÈÉ®Êó∂Èó¥ -->
                                <div class="aes-time" id="aes-live-time">--:-- PM</div>

                                <!-- 2. ÂèØÁºñËæëÁöÑÊ∞îÊ≥°ÊñáÊ°à -->
                                <div class="aes-bubble-row">
                                    <div class="aes-bubble" contenteditable="true" id="aes-editable-text"
                                        onblur="saveAesText()">
                                        love yourself. üíï
                                    </div>
                                </div>

                                <!-- 3. ‰∏≠Èó¥Âå∫ÂüüÔºöÂ∑¶‰æßË£ÖÈ•∞ + Âè≥‰æßÁÖßÁâá (ËøôÈáå‰πãÂâçË¥¥‰π±‰∫ÜÔºåÁé∞Âú®ÊòØ‰øÆÂ§çÂ•ΩÁöÑ) -->
                                <div class="aes-middle-section">
                                    <!-- Â∑¶‰æßË£ÖÈ•∞ÔºöÁÆ≠Â§¥ÊåáÂêëÂè≥Ëæπ -->
                                    <div class="aes-decor-left">
                                        <div class="aes-icon-smiley">
                                            <i class='bx bx-happy-beaming'></i>
                                        </div>
                                        <div class="aes-icon-arrow">
                                            <i class='bx bxs-navigation'></i>
                                        </div>
                                    </div>

                                    <!-- Âè≥‰æßÁÖßÁâáÂÆπÂô® -->
                                    <div class="aes-photo-frame" onclick="triggerWidgetUpload('aesthetic-photo')">
                                        <img id="img-aesthetic-photo" src="assets/icons/icon-placeholder.png"
                                            style="opacity:0;">
                                        <div class="upload-hint-text" style="color:#666; font-size:10px;">Change</div>
                                    </div>
                                </div>

                                <!-- 4. Â∫ïÈÉ®‰º™Ë£ÖËæìÂÖ•Ê°Ü -->
                                <div class="aes-input-bar">
                                    <span class="aes-input-placeholder">Message...</span>
                                    <div class="aes-input-icons">
                                        <i class='bx bx-microphone'></i>
                                        <i class='bx bx-image'></i>
                                        <div class="aes-plus-circle"><i class='bx bx-plus'></i></div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </section>

                    <!-- =========================================================
         Á¨¨‰∏âË°åÔºöÂ∑¶‰æß(Â§ßÊñπÂùóÁÖßÁâáÂ¢ô) + Âè≥‰æß(4‰∏™APP)
         ========================================================= -->
                    <section class="desktop-section desktop-main">
                        <div class="desktop-main-left">
                            <!-- Â∑¶‰∏ãËßíÂ§ßÊñπÂùóÔºöÁÇπÂáª‰∏ä‰º†ÁÖßÁâá -->
                            <div class="main-widget-card" onclick="triggerWidgetUpload('main-widget')">
                                <!-- Ê≤°ÂõæÊó∂ÁöÑÂç†‰ΩçÁ¨¶ -->
                                <div class="main-widget-placeholder">
                                    <i class='bx bx-plus'></i>
                                </div>
                                <!-- ÂõæÁâáÊú¨‰Ωì -->
                                <img id="img-main-widget" src="" style="display:none;"
                                    onload="this.style.display='block'; this.previousElementSibling.style.display='none'">
                            </div>
                        </div>

                        <div class="desktop-main-right">
                            <div class="app-grid-2x2">
                                <div class="app-item-small" id="app-item-4">
                                    <i id="app-icon-4" class="fas fa-gamepad"></i>
                                    <span id="app-name-4" class="app-icon-text">Ê∏∏Êàè</span>
                                </div>

                                <div class="app-item-small" id="app-item-5">
                                    <i id="app-icon-5" class="fas fa-envelope"></i>
                                    <span id="app-name-5" class="app-icon-text">‰ø°ÁÆ±</span>
                                </div>
                                <div class="app-item-small" id="app-item-6">
                                    <i id="app-icon-6" class="fas fa-truck"></i>
                                    <span id="app-name-6" class="app-icon-text">È©øÁ´ô</span>
                                </div>
                                <div class="app-item-small" id="app-item-7">
                                    <i id="app-icon-7" class="fas fa-ellipsis-h"></i>
                                    <span id="app-name-7" class="app-icon-text">Êõ¥Â§ö</span>
                                </div>
                            </div>
                        </div>
                    </section>


                </div>


                <!-- --- ÊµÆÂä®Â±ÇÔºöDock (‰øùÊåÅ‰∏çÂä®) --- -->
                <!-- --- ÊµÆÂä®Â±ÇÔºöDock (‰øùÊåÅ‰∏çÂä®) --- -->
                <div class="dock">
                    <!-- 1. ËÆæÁΩÆÊåâÈíÆ -->
                    <div class="dock-item" onclick="openApp('settings')">
                        <div class="dock-icon-img">‚öôÔ∏è</div>
                        <span>ËÆæÁΩÆ</span>
                    </div>

                    <!-- 2. TODOÂ∫îÁî® -->
                    <div class="dock-item" onclick="openApp('todo')">
                        <div class="dock-icon-img">‚úì</div>
                        <span>TODO</span>
                    </div>

                    <!-- 3. Â§ñËßÇÊåâÈíÆ -->
                    <div class="dock-item" onclick="openApp('appearance')">
                        <div class="dock-icon-img">üé®</div>
                        <span>Â§ñËßÇ</span>
                    </div>
                </div>

                <!-- ÈÄöÁî®ÁöÑ App ÂÖ®Â±èÂÆπÂô® -->
                <div id="app-window" class="app-window">
                    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
                    <div class="app-header">
                        <!-- 1. ËøîÂõûÊåâÈíÆÔºàÂ¢ûÂä†‰∫Ü‰∏Ä‰∏™ÈöêËóèÂä†Âè∑ÁöÑÂä®‰ΩúÔºâ -->
                        <div class="back-btn"
                            onclick="closeApp(); document.getElementById('top-plus-btn').style.display='none'">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                            </svg>
                            <span>ËøîÂõû</span>
                        </div>

                        <div class="app-title" id="app-title-text">Â∫îÁî®ÂêçÁß∞</div>

                        <!-- 2. ËøôÈáåÂ∞±ÊòØ‰Ω†Ë¶ÅÁöÑÂä†Âè∑ÔºÅÈªòËÆ§ÈöêËóè -->
                        <div id="top-plus-btn"
                            style="width: 40px; text-align: right; cursor: pointer; display: none; color: #000;"
                            onclick="openCreator()">
                            <i class="fas fa-plus" style="font-size: 18px;"></i>
                        </div>
                    </div>

                    <!-- App ÂÜÖÂÆπÂå∫Âüü (Âä®ÊÄÅÂèòÂåñ) -->
                    <div class="app-content" id="app-content-area">
                        <!-- ÁÇπÂáª‰∏çÂêåÁöÑÂõæÊ†áÔºåËøôÈáåÁöÑÂÜÖÂÆπ‰ºöÂèò -->
                    </div>
                </div>
                <!-- 2. ÈÄöÁî®ËßíËâ≤ÂºπÁ™ó (Êñ∞Âª∫ + ÁºñËæëÂêàÂπ∂Áâà) -->
                <div id="creator-modal" class="modal-layer" style="display: none;">
                    <div class="creator-header">
                        <!-- Ê†áÈ¢ò ID Êîπ‰∏∫ modal-titleÔºåÊñπ‰æø JS Âä®ÊÄÅ‰øÆÊîπ -->
                        <span style="flex: 1; text-align: center; font-weight: bold; font-size: 17px;"
                            id="modal-title">ÂàõÂª∫ËßíËâ≤</span>
                    </div>
                    <div class="creator-body">
                        <!-- Â§¥ÂÉè -->
                        <div class="avatar-upload-zone" onclick="document.getElementById('ai-avatar-file').click()">
                            <img id="avatar-preview" src="assets/default-avatar.png">
                            <p>ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</p>
                            <input type="file" id="ai-avatar-file" accept="image/*" style="display: none;"
                                onchange="previewAvatar(this)">
                        </div>
                        <!-- ËæìÂÖ•Ê°Ü (ID ‰øùÊåÅ ai- ÂºÄÂ§¥) -->
                        <div class="input-group">
                            <label>ËßíËâ≤ÂêçÁß∞</label>
                            <input type="text" id="ai-name" placeholder="">
                        </div>
                        <div class="input-group">
                            <label>ÊÄßÊ†ºËÆæÂÆö / Prompt</label>
                            <textarea id="ai-personality" placeholder="‰æãÂ¶ÇÔºöÂÇ≤Â®á„ÄÅÊØíËàå..."></textarea>
                        </div>
                        <div class="input-group">
                            <label>ËÅäÂ§©È£éÊ†º</label>
                            <input type="text" id="ai-style" placeholder="‰æãÂ¶ÇÔºöÂñúÊ¨¢ÂèëÈ¢úÊñáÂ≠ó...">
                        </div>
                        <div class="input-group">
                            <label>‰ΩúÊÅØË°® (Áî®‰∫éAIÊÑüÁü•Êó∂Èó¥)</label>
                            <textarea id="ai-schedule" placeholder="‰æãÂ¶ÇÔºö7:00 Ëµ∑Â∫ä   9:00 -18:00 Â∑•‰Ωú 23:00 Áù°Ëßâ"></textarea>
                        </div>
                        <!-- üî• Êñ∞Â¢ûÔºöÂÖ≥ËÅî‰∏ñÁïå‰π¶ -->
                        <div class="input-group">
                            <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (ËÉåÊôØËÆæÂÆö)</label>
                            <select id="ai-worldbook-select"
                                style="width:100%; padding:12px 0; border:none; background:#fff; font-size:16px;">
                                <option value="">Âä†ËΩΩ‰∏≠...</option>
                            </select>
                        </div>


                        <!-- ÊåâÈíÆÂå∫ÔºöÊîπ‰∏∫Áªü‰∏ÄÁöÑ saveCharacterData() -->
                        <div class="creator-footer-btns">
                            <button class="cancel-btn-large" onclick="closeCreator()">ÂèñÊ∂à</button>
                            <button class="save-btn-large" onclick="saveCharacterData()">‰øùÂ≠ò</button>
                        </div>
                        <div style="height: 40px;"></div>
                    </div>
                </div>

            </div>
            <!-- ========== „ÄêÊ°åÈù¢Â§ßÁõíÂ≠êÁªìÊùü„Äë ========== -->


            <!-- ========== „ÄêËÅäÂ§©Â§ßÁõíÂ≠êÔºàÊúÄÁªàÊó†Â£≥‰øÆÊ≠£ÁâàÔºâ„Äë ========== -->
            <div id="chat-view" style="display: none;">

                <!-- === 1. È°∂ÈÉ®Áä∂ÊÄÅÊ†è (‰º™Ë£ÖÊàêÊâãÊú∫Áä∂ÊÄÅÊ†è) === -->
                <div class="status-bar"
                    style="position: absolute; top: 0; width: 100%; z-index: 60; background: transparent;">
                    <div class="status-time" id="status-time-text-chat" style="color: #000;">--:--</div>
                    <div class="battery-icon">
                        <span class="battery-level" id="battery-num-chat" style="color: #000;">--</span>
                    </div>
                </div>

                <!-- === 2. ËÅäÂ§©ÂÆ§‰∏ª‰ΩìÂÜÖÂÆπ === -->
                <div id="chat-room-layer" class="custom-chat-background"
                    style="display: block; width: 100%; height: 100%; background: #f5f5f5;">

                    <div class="chat-room-header custom-top-bar"
                        style="padding-top: 40px; height: 80px; align-items: flex-end; padding-bottom: 10px;">
                        <div class="back-btn" onclick="backToList()">
                            <i class="fas fa-chevron-left"></i>
                            <span>ÂæÆ‰ø°</span>
                        </div>
                        <div class="chat-room-title-wrap">
                            <div class="chat-room-title" id="current-chat-name" style="margin-bottom: 5px;">Âä†ËΩΩ‰∏≠...</div>
                            <div class="status-heart-btn" id="status-heart-btn" onclick="openStatusMonitorPanel()">
                                <i class='bx bxs-heart'></i>
                            </div>
                        </div>
                        <div class="chat-room-menu" onclick="openChatSettings()" style="margin-bottom: 5px;">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                    </div>

                    <div id="status-monitor-modal" class="status-monitor-modal" style="display: none;"
                        onclick="handleStatusMonitorMaskClick(event)">
                        <div class="status-monitor-card">
                            <div class="status-monitor-header">
                                <div class="status-monitor-avatar">
                                    <img id="status-monitor-avatar-img" src="assets/default-avatar.png">
                                </div>
                                <div class="status-monitor-header-right">
                                    <div id="status-monitor-time" class="status-monitor-time">--Êúà--Êó• --:--</div>
                                    <div class="status-monitor-divider"></div>
                                    <div id="status-monitor-location" class="status-monitor-location">Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...</div>
                                </div>
                            </div>

                            <div class="status-monitor-section status-monitor-stats">
                                <div class="status-monitor-text-row">
                                    <div class="status-monitor-text-label">ÂøÉÊÉÖ</div>
                                    <div class="status-monitor-text-value" id="status-mood-text">Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...</div>
                                </div>
                                <div class="status-monitor-text-row">
                                    <div class="status-monitor-text-label">ÊÄßÂπªÊÉ≥</div>
                                    <div class="status-monitor-text-value status-monitor-fantasy"
                                        id="status-fantasy-text">Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">Â•ΩÊÑüÂ∫¶</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-favorability-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-favorability-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">ÂêÉÈÜãÂÄº</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-jealousy-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-jealousy-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">Âç†ÊúâÊ¨≤</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-possessiveness-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-possessiveness-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">ÊÄßÊ¨≤ÂÄº</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-lust-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-lust-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">ÂøÉÁéá</div>
                                    <div class="status-progress-bar status-heart-bar">
                                        <div class="status-progress-fill" id="status-heart-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-heart-text">-- BPM</div>
                                </div>
                            </div>

                            <div class="status-monitor-section status-monitor-inner">
                                <div class="status-inner-title" id="status-inner-title">Ê≠§ÂàªÂøÉÂ£∞</div>
                                <div class="status-inner-content" id="status-thought-text">
                                    Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏≠Èó¥Ê∂àÊÅØÂå∫ -->
                    <div class="chat-room-body custom-chat-area" id="chat-history" style="height: calc(100% - 140px);">
                        <!-- Ê∂àÊÅØ‰ºöÊèíÂú®ËøôÈáå -->
                    </div>

                    <!-- Â∫ïÈÉ®ËæìÂÖ•Ê†è (‰øÆÊîπÂêéÔºöÂåÖÂê´ÂºïÁî®Êù°) -->
                    <div style="background: #f7f7f7; border-top: 1px solid #dcdcdc;">

                        <!-- Êñ∞Â¢ûÔºöÂºïÁî®ÊòæÁ§∫Êù° (ÈªòËÆ§ÈöêËóè) -->
                        <div id="quote-bar"
                            style="display:none; padding: 8px 15px; align-items: center; background:#f5f5f5; border-bottom:1px solid #e5e5e5;">
                            <div class="quote-text" id="quote-content"
                                style="flex:1; font-size:12px; color:#666; border-left: 3px solid #888; padding-left:8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                ÂºïÁî®ÂÜÖÂÆπ...
                            </div>
                            <div class="quote-close" onclick="cancelQuote()"
                                style="padding:0 10px; font-size:18px; color:#999; cursor:pointer;">√ó</div>
                        </div>

                        <!-- ÂéüÊù•ÁöÑÂ∫ïÈÉ®Êìç‰ΩúÊ†è (ÂéªÊéâ‰∏äËæπÊ°ÜÔºåÂõ†‰∏∫Áà∂Á∫ßÂä†‰∫Ü) -->
                        <div class="chat-room-footer custom-bottom-bar" style="border-top: none;">
                            <div class="icon-btn-round icon-btn-plus custom-menu-btn" id="more-btn">
                                <i class="fas fa-plus"></i>
                            </div>
                            <input type="text" id="msg-input" class="custom-input-field" placeholder="ÂèëÊ∂àÊÅØ...">

                            <!-- Êñ∞Â¢ûÔºöÂø´ÈÄüË°®ÊÉÖÊåâÈíÆ -->
                            <div id="quick-emoji-btn" class="icon-btn-round custom-menu-btn">
                                <i class='bx bx-happy'></i>
                            </div>

                            <div class="footer-btns">
                                <div class="icon-btn-round" onclick="triggerAI()">
                                    <i class="fas fa-magic"></i>
                                </div>
                                <button class="send-btn-rect custom-send-btn" onclick="sendMessage()">ÂèëÈÄÅ</button>
                            </div>
                        </div>

                        <div id="chat-more-panel" class="chat-more-panel">
                            <div class="chat-more-pages" id="chat-more-pages"></div>
                            <div class="chat-more-dots" id="chat-more-dots"></div>
                            <div id="chat-sticker-panel" class="chat-sticker-panel">
                                <div class="sticker-tabs">
                                    <div class="sticker-tab active" data-type="mine">ÊàëÁöÑ</div>
                                    <div class="sticker-tab" data-type="his">‰ªñÁöÑ</div>
                                    <div class="sticker-tab" data-type="general">ÈÄöÁî®</div>
                                    <div class="sticker-tab-add" id="sticker-add-btn">+</div>
                                </div>
                                <div class="sticker-grid" id="sticker-grid"></div>
                            </div>
                        </div>
                    </div>
                    <!-- === Êñ∞Â¢ûÔºöÂ§öÈÄâÂ∫ïÈÉ®Â∑•ÂÖ∑Ê†è === -->
                    <div id="multi-select-bar">
                        <div class="multi-btn" onclick="performMultiAction('forward')">
                            <i class="fas fa-share"></i>
                            <span>ËΩ¨Âèë</span>
                        </div>
                        <div class="multi-btn" onclick="performMultiAction('fav')">
                            <i class="fas fa-cube"></i> <!-- ÂæÆ‰ø°Êî∂ËóèÊòØ‰∏™Á´ãÊñπ‰ΩìÔºåËøôÈáåÁî®cubeÊàñËÄÖstar -->
                            <span>Êî∂Ëóè</span>
                        </div>
                        <div class="multi-btn delete-btn" onclick="performMultiAction('delete')">
                            <i class="fas fa-trash"></i>
                            <span>Âà†Èô§</span>
                        </div>
                    </div>
                    <input type="file" id="chat-image-uploader" accept="image/*" style="display:none;">

                </div>

                <div id="voice-call-overlay" class="voice-call-overlay" style="display:none;">
                    <div class="voice-call-header">
                        <div id="voice-call-minimize" class="voice-call-minimize">
                            <i class='bx bx-chevron-down'></i>
                        </div>
                    </div>
                    <div class="voice-call-main">
                        <div class="voice-call-avatar-box">
                            <img id="voice-call-avatar" class="voice-call-avatar" src="assets/default-avatar.png"
                                alt="">
                        </div>
                        <div class="voice-call-chat-wrapper">
                            <div id="call-chat-container" class="call-chat-container"></div>
                        </div>
                    </div>
                    <div class="voice-call-footer">
                        <div id="voice-call-status" class="voice-call-status-text">Á≠âÂæÖÂØπÊñπÊé•ÂèóÈÇÄËØ∑...</div>
                        <div id="voice-call-input-row" class="voice-call-input-row" style="display:none;">
                            <input id="voice-call-input" class="voice-call-input" type="text" placeholder="Âú®ÈÄöËØù‰∏≠ÂèëÊ∂àÊÅØ...">
                            <button id="voice-call-send" class="voice-call-send-btn">ÂèëÈÄÅ</button>
                        </div>
                        <div class="voice-call-buttons">
                            <button id="voice-call-mic-btn" class="call-btn call-btn-small">
                                <i class='bx bx-microphone'></i>
                            </button>
                            <button id="voice-call-hangup-btn" class="call-btn call-btn-hangup">
                                <i class='bx bx-phone-off'></i>
                            </button>
                            <button id="voice-call-speaker-btn" class="call-btn call-btn-small">
                                <i class='bx bx-volume-full'></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="call-float-window" class="call-float-window" style="display:none;">
                    <span>ÈÄöËØù‰∏≠...</span>
                </div>

                <div id="location-share-float-window" class="location-share-float-window" style="display:none;">
                    <span id="location-share-float-text">‰ΩçÁΩÆÂÖ±‰∫´‰∏≠...</span>
                </div>

                <!-- =======================================================
                     === 3. ÂºπÁ™óÂå∫ (ÊîæÂú®ËøôÈáåÔºå‰øùËØÅÂú®ËÅäÂ§©ÂÆ§‰πã‰∏ä) ===
                     ======================================================= -->

                <div id="sticker-import-modal" class="modal-layer" style="display:none; background: rgba(0,0,0,0.4);">
                    <div
                        style="margin:auto; width:90%; max-width:320px; background:#fff; border-radius:12px; padding:15px; box-sizing:border-box;">
                        <div style="font-size:16px; font-weight:600; margin-bottom:8px;">ÂØºÂÖ•Ë°®ÊÉÖÂåÖ</div>
                        <div style="margin-bottom:8px; font-size:14px;">
                            <label for="sticker-import-category">ÂØºÂÖ•Âà∞ÂàÜÁªÑÔºö</label>
                            <select id="sticker-import-category"
                                style="width:100%; margin-top:4px; padding:6px 8px; font-size:14px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                                <option value="mine">ÊàëÁöÑË°®ÊÉÖ</option>
                                <option value="his">‰ªñÁöÑË°®ÊÉÖ</option>
                                <option value="general">ÈÄöÁî®Ë°®ÊÉÖ</option>
                            </select>
                        </div>
                        <div style="margin-bottom:10px;">
                            <textarea id="sticker-import-text" placeholder="ÊØèË°å‰∏ÄÊù°ÔºöÂêçÁß∞: URL"
                                style="width:100%; height:120px; box-sizing:border-box; border:1px solid #ddd; border-radius:6px; padding:8px; font-size:13px; resize:vertical;"></textarea>
                        </div>
                        <div style="text-align:right;">
                            <button
                                style="padding:6px 10px; margin-right:8px; border:none; background:#f0f0f0; border-radius:4px; font-size:13px;"
                                onclick="closeStickerImportModal()">ÂèñÊ∂à</button>
                            <button
                                style="padding:6px 12px; border:none; background:#07c160; color:#fff; border-radius:4px; font-size:13px;"
                                onclick="confirmStickerImport()">ÂØºÂÖ•</button>
                        </div>
                    </div>
                </div>

                <!-- A. ËÅäÂ§©ËÆæÁΩÆËèúÂçï (Âè≥‰∏äËßí‰∏â‰∏™ÁÇπ) -->
                <div id="settings-menu-modal" class="modal-layer" style="display: none; background: rgba(0,0,0,0.5);">
                    <!-- ÁÇπÂáªÂçäÈÄèÊòéËÉåÊôØÂÖ≥Èó≠ -->
                    <div style="position:absolute; width:100%; height:100%;" onclick="closeSettingsMenu()"></div>

                    <!-- ËèúÂçïÂÜÖÂÆπ (‰ªéÂ∫ïÈÉ®ÊªëÂá∫) -->
                    <div class="modal-content settings-list-layout"
                        style="position: absolute; bottom: 0; width: 100%; border-radius: 20px 20px 0 0;">
                        <div class="modal-header-bar">
                            <div class="modal-close-icon" onclick="closeSettingsMenu()">√ó</div>
                            <div class="modal-title">ËÅäÂ§©‰ø°ÊÅØ</div>
                            <div class="modal-placeholder"></div>
                        </div>

                        <div class="settings-group" onclick="openCharacterEditor()">
                            <div class="profile-card">
                                <img id="menu-role-avatar" src="assets/default-avatar.png" class="profile-avatar">
                                <div class="profile-info">
                                    <div class="profile-name" id="menu-role-name">ËßíËâ≤Âêç</div>
                                    <div class="profile-desc" id="menu-role-desc">ÁÇπÂáªÊü•ÁúãÊ°£Ê°à...</div>
                                </div>
                                <div class="chevron">‚Ä∫</div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-item" onclick="openUserPersonaModal()">
                                <div class="item-label">ÊàëÁöÑÂΩìÂâçË∫´‰ªΩ</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" style="cursor: default; height:auto;">
                                <div style="flex:1;">
                                    <div class="item-label">Áü≠ÊúüËÆ∞ÂøÜÊù°Êï∞</div>
                                    <div
                                        style="margin-top:4px; display:flex; justify-content:space-between; align-items:center;">
                                        <input type="number" id="setting-memory-limit" value="50"
                                            onchange="saveChatSettings()"
                                            style="width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px;">
                                        <span style="font-size: 10px; color: #999; margin-left:10px;">50~100
                                            Êù°‰∏∫Êé®ËçêËåÉÂõ¥</span>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-item" style="cursor: default; height:auto;">
                                <div style="flex:1;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div class="item-label">Ëá™Âä®ÊÄªÁªì</div>
                                        <label class="switch">
                                            <input type="checkbox" id="setting-auto-summary-switch"
                                                onchange="toggleSummaryInput(); saveChatSettings();">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div id="setting-summary-freq-box"
                                        style="display: none; margin-top: 8px; align-items: center; justify-content: space-between;">
                                        <span style="font-size: 12px; color: #666;">ÊØèÂ§öÂ∞ëÊù°ÊÄªÁªì‰∏ÄÊ¨°:</span>
                                        <input type="number" id="setting-summary-freq" value="20"
                                            onchange="saveChatSettings()"
                                            style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                            </div>

                            <div class="settings-item" onclick="openMemoryArchiveModal()">
                                <div class="item-label">ËÆ∞ÂøÜÊ°£Ê°à</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" onclick="openCallLogModal()">
                                <div class="item-label">ÈÄöËØùËÆ∞ÂΩï</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" onclick="openBgSettingModal()">
                                <div class="item-label">ËÅäÂ§©ËÉåÊôØ</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" style="cursor: default; height:auto; border-bottom:none;">
                                <div style="flex:1;">
                                    <div class="item-label" style="margin-bottom: 5px;">Ëá™ÂÆö‰πâÊ∞îÊ≥°Ê†∑Âºè (CSS)</div>
                                    <div
                                        style="background: #ededed; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                        <div id="bubble-preview">
                                            <div style="display:flex; align-items:flex-start; margin-bottom:8px;">
                                                <div class="preview-avatar-left"
                                                    style="width: 32px; height: 32px; border-radius: 4px; overflow:hidden; background:#ccc; flex-shrink:0; margin-right:8px;">
                                                    <img src="assets/default-avatar.png"
                                                        style="width:100%; height:100%; object-fit:cover;">
                                                </div>
                                                <div class="preview-bubble-left"
                                                    style="background: #ffffff; padding: 8px 12px; border-radius: 4px; font-size: 14px; max-width: 70%; color: #000;">
                                                    AIÔºöHello
                                                </div>
                                            </div>
                                            <div
                                                style="display:flex; align-items:flex-start; justify-content:flex-end;">
                                                <div class="preview-bubble-right"
                                                    style="background: #95ec69; padding: 8px 12px; border-radius: 4px; font-size: 14px; max-width: 70%; color: #000; margin-right:8px;">
                                                    ÊàëÔºöHello
                                                </div>
                                                <div class="preview-avatar-right"
                                                    style="width: 32px; height: 32px; border-radius: 4px; overflow:hidden; background:#ccc; flex-shrink:0;">
                                                    <img src="assets/default-avatar.png"
                                                        style="width:100%; height:100%; object-fit:cover;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <textarea id="setting-bubble-css"
                                        placeholder="ËæìÂÖ•CSS‰ª£Á†ÅÔºå‰æãÂ¶Ç: background: pink; color: white;"
                                        style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 5px; font-size: 12px; font-family: monospace;"
                                        oninput="updateBubblePreview(); saveChatSettings();"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-item text-danger" onclick="clearChatHistory()">
                                <div class="item-label" style="color: #ff3b30;">
                                    Ê∏ÖÁ©∫‰∏éTAÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-item text-danger" onclick="deleteCurrentCharacter()">
                                <div class="item-label" style="color: #ff3b30; font-weight: bold;">
                                    Âà†Èô§ÂΩìÂâçËßíËâ≤
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =======================================================
     ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è ËØ∑Áî®ËøôÊÆµ‰ª£Á†Å ÊõøÊç¢ÊéâÂéüÊù•ÁöÑ B ÈÉ®ÂàÜ (editor-modal-deleted) ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
     ======================================================= -->

                <!-- B. ËßíËâ≤ÁºñËæëÂºπÁ™ó (‰øÆÊ≠£ÁâàÔºöÂä†Âõû‰∫Ü modal-layer ËøôÊ†∑ÂÆÉÊâç‰ºöÊµÆÂú®ÊúÄ‰∏äÈù¢ÔºÅ) -->
                <div id="editor-modal" class="modal-layer" style="display: none; background: #fff;">
                    <div class="modal-header-bar" style="padding-top: 40px;">
                        <!-- ËøôÈáå‰∏çÈúÄË¶ÅËøîÂõûÁÆ≠Â§¥ÔºåÂõ†‰∏∫ÁºñËæëÂè™Êúâ‰øùÂ≠òÂíåÂèñÊ∂à -->
                        <div class="modal-placeholder"></div>
                        <div class="modal-title">ÁºñËæëËßíËâ≤</div>
                        <div class="modal-placeholder"></div>
                    </div>

                    <div class="creator-body">
                        <!-- Â§¥ÂÉèÂå∫ -->
                        <div class="avatar-upload-zone"
                            onclick="document.getElementById('edit-ai-avatar-file').click()">
                            <img id="edit-avatar-preview" src="assets/default-avatar.png">
                            <p>ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</p>
                            <input type="file" id="edit-ai-avatar-file" accept="image/*" style="display: none;"
                                onchange="previewEditAvatar(this)">
                        </div>

                        <!-- ËæìÂÖ•Ê°Ü (ID ÂøÖÈ°ªÊòØ edit- ÂºÄÂ§¥ÁöÑÔºåÈÖçÂêà JS) -->
                        <div class="input-group">
                            <label>ËßíËâ≤ÂêçÁß∞</label>
                            <input type="text" id="edit-ai-name">
                        </div>
                        <div class="input-group">
                            <label>ÊÄßÊ†ºËÆæÂÆö / Prompt</label>
                            <textarea id="edit-ai-personality"></textarea>
                        </div>
                        <div class="input-group">
                            <label>ËÅäÂ§©È£éÊ†º</label>
                            <input type="text" id="edit-ai-style">
                        </div>
                        <div class="input-group">
                            <label>‰ΩúÊÅØË°®</label>
                            <textarea id="edit-ai-schedule"></textarea>
                        </div>
                        <!-- üî• Êñ∞Â¢ûÔºöÂÖ≥ËÅî‰∏ñÁïå‰π¶ -->
                        <div class="input-group">
                            <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶</label>
                            <select id="edit-ai-worldbook-select"
                                style="width:100%; padding:12px 0; border:none; background:#fff; font-size:16px;">
                                <option value="">Âä†ËΩΩ‰∏≠...</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>ËßÜÈ¢ëÈÄöËØùÁõ∏ÂÜå</label>
                            <div id="edit-video-album-list" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                            <div style="margin-top:8px;">
                                <button
                                    style="padding:6px 12px; border:none; border-radius:6px; background:#07c160; color:#fff; font-size:14px;"
                                    onclick="document.getElementById('edit-video-album-file').click()">
                                    Ê∑ªÂä†ÂõæÁâá
                                </button>
                                <input type="file" id="edit-video-album-file" accept="image/*" style="display:none;"
                                    onchange="handleEditVideoAlbumFile(this)">
                            </div>
                        </div>

                        <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
                        <div class="creator-footer-btns">
                            <button class="cancel-btn-large" onclick="closeEditor()">ÂèñÊ∂à</button>
                            <button class="save-btn-large" onclick="saveEditResult()">‰øùÂ≠ò‰øÆÊîπ</button>
                        </div>
                        <!-- Â∫ïÈÉ®Âû´È´ò -->
                        <div style="height: 50px;"></div>
                    </div>
                </div>

                <!-- =======================================================
     ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è ËØ∑ÊääËøôÈÉ®ÂàÜÂÆåÊï¥Â§çÂà∂ÔºåÊõøÊç¢ÊéâÂéüÊù•ÁÆÄÈôãÁöÑ C Âíå D ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
     ======================================================= -->

                <!-- C. ÊàëÁöÑË∫´‰ªΩÂºπÁ™ó (Ê†∑Âºè‰øÆÂ§çÁâàÔºöÂ∏¶È¢ÑËÆæÊåâÈíÆ„ÄÅÂ±Ö‰∏≠Â§¥ÂÉè) -->
                <div id="user-persona-modal" class="modal-layer" style="display: none; background: #fff;">
                    <div class="modal-header-bar" style="padding-top: 40px;">
                        <div class="modal-close-icon" onclick="closeSubModal('user-persona-modal')">‚Äπ</div>
                        <div class="modal-title">ÊàëÁöÑË∫´‰ªΩ</div>
                        <div class="modal-placeholder"></div>
                    </div>
                    <div class="creator-body">
                        <!-- ÊºÇ‰∫ÆÁöÑÂ±Ö‰∏≠Â§¥ÂÉèÂå∫ -->
                        <div class="input-group" style="text-align: center; margin-top: 20px;">
                            <label>ÊàëÂú®ËØ•ËÅäÂ§©‰∏≠ÁöÑÂ§¥ÂÉè</label>
                            <div class="avatar-upload-zone"
                                onclick="document.getElementById('user-avatar-input').click()"
                                style="width: 80px; height: 80px; margin: 10px auto;">
                                <img id="user-settings-avatar" src="assets/default-avatar.png"
                                    style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                <input type="file" id="user-avatar-input" hidden onchange="previewUserAvatar(this)">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>ÊàëÂú®ËØ•ËÅäÂ§©‰∏≠ÁöÑÂêçÂ≠ó</label>
                            <input type="text" id="user-settings-name" placeholder="‰æãÂ¶ÇÔºöÂ∞èA / ËÄÅÂ©Ü">
                        </div>

                        <div class="input-group">
                            <label>ÊàëÁöÑËÆæÂÆö (ËÆ©AIÊõ¥‰∫ÜËß£‰Ω†)</label>
                            <textarea id="user-persona-setting" placeholder="‰æãÂ¶ÇÔºöÊàëÊòØ‰Ω†ÁöÑÂ•≥ÊúãÂèãÔºåÊÄßÊ†ºÊ∏©ÊüîÔºåÂñúÊ¨¢ÂêÉËæ£..."></textarea>
                        </div>

                        <div class="creator-footer-btns">
                            <button class="save-btn-large" onclick="saveUserPersona()">‰øùÂ≠òËÆæÂÆö</button>
                            <!-- ÊääËøô‰∏™ËìùËâ≤ÁöÑÊåâÈíÆÂä†ÂõûÊù•‰∫Ü -->
                            <button class="save-btn-large" id="btn-save-user-preset"
                                style="background-color: #007aff; margin-right: 10px;">Â≠ò‰∏∫È¢ÑËÆæ</button>
                        </div>
                        <!-- Â∫ïÈÉ®Âû´È´òÔºåÈò≤Ê≠¢Ë¢´ÈîÆÁõòÊå°‰Ωè -->
                        <div style="height: 50px;"></div>
                    </div>
                </div>

                <!-- D. ËÉåÊôØËÆæÁΩÆÂºπÁ™ó (Ê†∑Âºè‰øÆÂ§çÁâàÔºöÂ∏¶Â±Ö‰∏≠ÊñáÂ≠ó„ÄÅFlexÂ∏ÉÂ±Ä) -->
                <div id="bg-setting-modal" class="modal-layer" style="display: none; background: #fff;">
                    <div class="modal-header-bar" style="padding-top: 40px;">
                        <div class="modal-close-icon" onclick="closeSubModal('bg-setting-modal')">‚Äπ</div>
                        <div class="modal-title">ËÅäÂ§©ËÉåÊôØ</div>
                        <div class="modal-placeholder"></div>
                    </div>
                    <div class="creator-body" style="text-align: center;">

                        <!-- ÊºÇ‰∫ÆÁöÑÈ¢ÑËßàÊ°Ü -->
                        <div class="bg-preview-box" id="bg-preview-box"
                            style="height: 300px; background-color: #eee; margin: 20px; border-radius: 10px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999;">
                            ÂΩìÂâçËÉåÊôØÈ¢ÑËßà
                        </div>

                        <input type="file" id="bg-file-input" hidden onchange="previewChatBg(this)">

                        <div class="creator-footer-btns">
                            <button class="cancel-btn-large"
                                onclick="document.getElementById('bg-file-input').click()">‰∏ä‰º†ÂõæÁâá</button>
                            <button class="save-btn-large" onclick="saveChatBg()">‰øùÂ≠òËÉåÊôØ</button>
                        </div>

                        <button class="text-btn" onclick="resetChatBg()"
                            style="margin-top:15px; color: red; background:none; border:none;">ÊÅ¢Â§çÈªòËÆ§ËÉåÊôØ</button>
                    </div>
                </div>

                <!-- E. ËÆ∞ÂøÜÊ°£Ê°à (ÂÖ®Â±èÊ°£Ê°àÊü•ÈòÖÈù¢ÊùøÔºöÂ∑¶ÂÜÖÂÆπÂè≥ÂØºËà™) -->
                <div id="memory-archive-modal" class="modal-layer" style="display: none; background: #f2f2f7;">
                    <div class="modal-header-bar">
                        <div class="modal-placeholder"></div>
                        <div class="modal-title">ËÆ∞ÂøÜÊ°£Ê°à</div>
                        <div class="modal-close-icon" onclick="closeMemoryArchiveModal()">√ó</div>
                    </div>

                    <div class="memory-archive-outer">
                        <div class="memory-archive-folder">
                            <!-- ‰∏ª‰ΩìÂå∫ÂüüÔºàÂ∑¶ 75%Ôºâ -->
                            <div class="memory-archive-content">
                                <div class="memory-archive-content-title" id="memory-archive-title">TAÁöÑÂñúÂ•Ω</div>
                                <div class="memory-archive-content-text" id="memory-archive-text"></div>
                            </div>

                            <!-- ‰æßËæπÂØºËà™ÔºàÂè≥ 25%Ôºâ -->
                            <div class="memory-archive-nav">
                                <button class="memory-archive-tab is-active" data-key="likes"
                                    onclick="switchMemoryArchiveTab('likes')">TAÁöÑÂñúÂ•Ω</button>
                                <button class="memory-archive-tab" data-key="habits"
                                    onclick="switchMemoryArchiveTab('habits')">TAÁöÑ‰π†ÊÉØ</button>
                                <button class="memory-archive-tab" data-key="events"
                                    onclick="switchMemoryArchiveTab('events')">Êàë‰ª¨ÂèëÁîüÁöÑ‰∫ã</button>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ÈïøÊåâËèúÂçï‰ΩìÁ≥ª -->
                <!-- 1. ÂÖ®Â±èÈÅÆÁΩ© (ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÂÖ≥Èó≠) -->
                <div id="context-menu-mask" onclick="closeContextMenu()"></div>

                <!-- 2. ËèúÂçïÊú¨‰Ωì -->
                <div id="msg-context-menu">
                    <div class="menu-grid">
                        <!-- Á¨¨‰∏ÄË°å -->
                        <div class="menu-item" onclick="menuAction('edit')">
                            <div class="menu-icon">‚úé</div>
                            <div>ÁºñËæë</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('copy')"> <!-- Ë°•ÂÖÖ‰∏Ä‰∏™Â§çÂà∂ÔºåÂæàÂ∏∏Áî® -->
                            <div class="menu-icon">üìÑ</div>
                            <div>Â§çÂà∂</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('quote')">
                            <div class="menu-icon">‚ùû</div>
                            <div>ÂºïÁî®</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('trans')">
                            <div class="menu-icon">Êñá</div>
                            <div>ÁøªËØë</div>
                        </div>

                        <!-- Á¨¨‰∫åË°å -->
                        <div class="menu-item" onclick="menuAction('delete')">
                            <div class="menu-icon">üóëÔ∏è</div>
                            <div>Âà†Èô§</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('forward')">
                            <div class="menu-icon">‚Üó</div>
                            <div>ËΩ¨Âèë</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('fav')">
                            <div class="menu-icon">‚òÖ</div>
                            <div>Êî∂Ëóè</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('multi')">
                            <div class="menu-icon">‚òë</div>
                            <div>Â§öÈÄâ</div>
                        </div>
                        <!-- ÊèêÈÜíÊîæ‰∏ç‰∏ã‰∫ÜÔºåÂæÆ‰ø°‰∏ÄËà¨ÊòØÂêëÂè≥ÁøªÈ°µÔºåËøôÈáåÂÖà‰∏çÊîæÊàñËÄÖÊõøÊç¢Êéâ‰∏äÈù¢Êüê‰∏™ -->
                    </div>
                </div>

            </div>
            <!-- ========== „ÄêËÅäÂ§©Â§ßÁõíÂ≠êÁªìÊùü„Äë ========== -->


        </div>
        <div class="home-indicator"></div>
    </div>

    <!-- ÈÄöÁî®Êñá‰ª∂‰∏ä‰º†ËæìÂÖ•Ê°Ü (Â§çÁî®) -->
    <input type="file" id="global-uploader" accept="image/*" style="display:none;">


    <input type="file" id="wallpaper-uploader" accept="image/*" style="display:none;">

    <!-- === Êñ∞Â¢ûÔºöËΩ¨ÂèëËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂºπÁ™ó === -->
    <div id="forward-modal" class="modal-layer">
        <div class="forward-box">
            <div class="forward-header">
                <span>ÈÄâÊã©ÂèëÈÄÅÁªô...</span>
                <span class="close-btn" onclick="closeForwardModal()">√ó</span>
            </div>

            <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®ÂÆπÂô® -->
            <div id="forward-contact-list" class="forward-list">
                <!-- JS‰ºöËá™Âä®Â°´ÂÖÖËøôÈáå -->
            </div>
        </div>
    </div>
    <!-- ÂºïÂÖ•Â§ßÂÆπÈáèÂ≠òÂÇ®Â∫ì localForage - ‰ΩøÁî®BootCDN -->
    <!-- ÊõøÊç¢ÊéâÂéüÊù•ÁöÑ bootcdn ÈìæÊé•ÔºåÊîπÁî®Ëøô‰∏™ -->
    <script src="https://unpkg.com/localforage@1.10.0/dist/localforage.min.js"></script>

    <!-- 1. ÂºïÂÖ•AppÈÄªËæë -->
    <script src="JS/apps.js"></script>
    <!-- Êñ∞Â¢ûÔºöËÅäÂ§©‰∏ìÁî®ÈÄªËæë -->
    <script src="JS/api.js"></script>
    <script src="JS/chat.js"></script>
    <script src="JS/chat-settings.js"></script>
    <script src="JS/moments.js"></script>
    <script src="JS/ÊàëÁöÑ/profile.js"></script>
    <script src="JS/ÊàëÁöÑ/core.js"></script>
    <script src="JS/worldbook.js?v=2"></script>

    <!-- 2. ÂºïÂÖ• ÊäÄËÉΩÊï∞ÊçÆÈÄªËæë -->
    <script src="JS/widgets.js"></script>
    <script src="JS/slider.js"></script>
    <script src="JS/appearance.js"></script>
    <script src="JS/settings.js"></script>
    <!-- 3. ÂºïÂÖ• ÊÄªÁ≥ªÁªü ÁöÑÈÄªËæë (ÂøÖÈ°ªÂºïÂÖ•Ëøô‰∏™ÔºåÊåâÈíÆÊâç‰ºöÊúâÂèçÂ∫îÔºÅ) -->
    <script src="JS/system.js"></script>
    <script>
        /* =========================================================
           Service Worker Ê≥®ÂÜåÈÄªËæë (ÂøÖÈ°ªÂä†Ëøô‰∏™ÊâçËÉΩÂÆâË£ÖÂà∞Ê°åÈù¢ÔºÅ)
           ========================================================= */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ ServiceWorker Ê≥®ÂÜåÊàêÂäü: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('‚ùå ServiceWorker Ê≥®ÂÜåÂ§±Ë¥•: ', err);
                    });
            });
        }

        /* =========================================================
           ÂºÄÂ±èÂä®ÁîªÈÄªËæë
           ========================================================= */
        window.addEventListener('load', function () {
            const splashScreen = document.getElementById('splash-screen');
            const hasVisited = localStorage.getItem('has_visited_shubao_phone');

            if (hasVisited) {
                // Â∑≤ÁªèËÆøÈóÆËøáÔºåÂø´ÈÄüË∑≥ËøáÂä®Áîª
                if (splashScreen) {
                    splashScreen.style.display = 'none';
                }
            } else {
                // È¶ñÊ¨°ËÆøÈóÆÔºåÊòæÁ§∫ÂÆåÊï¥Âä®Áîª
                setTimeout(() => {
                    if (splashScreen) {
                        splashScreen.classList.add('fade-out');
                        setTimeout(() => {
                            splashScreen.style.display = 'none';
                            // Ê†áËÆ∞Â∑≤ËÆøÈóÆ
                            localStorage.setItem('has_visited_shubao_phone', 'true');
                        }, 500); // Á≠âÂæÖÊ∑°Âá∫Âä®ÁîªÂÆåÊàê
                    }
                }, 2000); // ÊòæÁ§∫2Áßí
            }

            // 1. ÂêØÂä®Â§ñËßÇÊÅ¢Â§ç (Â£ÅÁ∫∏„ÄÅAppÂõæÊ†á)
            if (window.initDesktopState) {
                window.initDesktopState();
            } else {
                setTimeout(() => window.initDesktopState && window.initDesktopState(), 100);
            }

            // 2. ÂêØÂä®ÁªÑ‰ª∂ÊÅ¢Â§ç (ÁªÑ‰ª∂ÂõæÁâá)
            if (window.initWidgetState) {
                window.initWidgetState();
            } else {
                setTimeout(() => window.initWidgetState && window.initWidgetState(), 100);
            }

        }); // ÁªìÊùü window load
    </script>
    <script>
        // === ÈÄöÁî®ÂõæÁâá‰∏ä‰º†Â§ÑÁêÜÂô® ===
        // 1. ÂÆö‰πâ‰∏Ä‰∏™ÂèòÈáèËÆ∞ÂΩïÂΩìÂâçÊ≠£Âú®Êìç‰ΩúÂì™‰∏™ÂÖÉÁ¥† ID
        let currentUploadTargetId = '';

        // 2. ÁÇπÂáªÁªÑ‰ª∂Êó∂Ë∞ÉÁî®ÁöÑÂáΩÊï∞
        function triggerWidgetUpload(imgId) {
            currentUploadTargetId = 'img-' + imgId; // ÊãºÂáëÂá∫ img Ê†áÁ≠æÁöÑ ID
            // Ëß¶ÂèëÈÇ£‰∏™ÈÄöÁî®ÁöÑÈöêËóèÊñá‰ª∂ËæìÂÖ•Ê°Ü
            document.getElementById('global-uploader').click();
        }

        // 3. ÁõëÂê¨Êñá‰ª∂ÈÄâÊã©ÂèòÂåñ
        document.getElementById('global-uploader').addEventListener('change', function (e) {
            if (!currentUploadTargetId) {
                return;
            }

            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const base64String = event.target.result;

                // A. ÊòæÁ§∫ÂõæÁâá
                const imgEl = document.getElementById(currentUploadTargetId);
                if (imgEl) {
                    imgEl.src = base64String;
                    imgEl.style.opacity = '1'; // ÊòæÁ§∫Âá∫Êù•
                }

                // B. ‰øùÂ≠òÂà∞ÂíåËÅäÂ§©ËÆ∞ÂΩïÁõ∏ÂêåÁöÑÂ§ßÂÆπÈáèÂ≠òÂÇ®
                try {
                    if (window.localforage) {
                        if (window.DB && typeof DB.configLargeStore === 'function') {
                            DB.configLargeStore();
                        }
                        localforage.setItem('widget_img_' + currentUploadTargetId, base64String);
                    } else {
                        localStorage.setItem('widget_save_' + currentUploadTargetId, base64String);
                    }
                } catch (err) {
                    console.error("‰øùÂ≠òÂ∞èÁªÑ‰ª∂ÂõæÁâáÂ§±Ë¥•", err);
                    alert("ÂõæÁâáÂ§™Â§ßÔºåÂèØËÉΩÊó†Ê≥ï‰øùÂ≠òÔºåÂª∫ËÆÆÊà™‰∏™ÂõæÂÜç‰º†~");
                }
            };
            reader.readAsDataURL(file);

            // Ê∏ÖÁ©∫ inputÔºåÈò≤Ê≠¢‰∏ãÊ¨°ÈÄâÂêåÂêçÊñá‰ª∂‰∏çËß¶Âèë
            this.value = '';
        });

        // 4. È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çÂõæÁâá
        function restoreWidgetImages() {
            const widgetIds = ['img-sticker-1', 'img-sticker-2', 'img-top-right-banner', 'img-aesthetic-photo', 'img-aesthetic-bg', 'img-main-widget'];
            widgetIds.forEach(id => {
                if (window.localforage) {
                    if (window.DB && typeof DB.configLargeStore === 'function') {
                        DB.configLargeStore();
                    }
                    localforage.getItem('widget_img_' + id).then(function (savedData) {
                        if (savedData) {
                            const imgEl = document.getElementById(id);
                            if (imgEl) {
                                imgEl.src = savedData;
                                imgEl.style.opacity = '1';
                            }
                        }
                    });
                } else {
                    const savedData = localStorage.getItem('widget_save_' + id);
                    if (savedData) {
                        const imgEl = document.getElementById(id);
                        if (imgEl) {
                            imgEl.src = savedData;
                            imgEl.style.opacity = '1';
                        }
                    }
                }
            });
        }

        // 5. Á´ãÂç≥ÊâßË°åÊÅ¢Â§ç
        window.addEventListener('load', restoreWidgetImages);
    </script>

    <script>
        // === INSÂç°ÁâáÂäüËÉΩÈÄªËæë (Êï¥ÂêàÁâà) ===

        // 1. ÂÆûÊó∂Êõ¥Êñ∞Âç°ÁâáÈ°∂ÈÉ®Êó∂Èó¥
        function updateAesTime() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const timeString = `${hours}:${minutes} ${ampm}`;

            const timeEl = document.getElementById('aes-live-time');
            if (timeEl) timeEl.innerText = timeString;
        }
        setInterval(updateAesTime, 1000); // ÊØèÁßíÂà∑Êñ∞
        updateAesTime(); // Á´ãÂç≥ÊâßË°å

        // 2. ‰øùÂ≠òÊ∞îÊ≥°ÊñáÊ°à
        function saveAesText() {
            const textEl = document.getElementById('aes-editable-text');
            if (textEl) {
                localStorage.setItem('aes_bubble_text', textEl.innerText);
            }
        }

        // 3. È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çÊñáÊ°à
        window.addEventListener('load', function () {
            const savedText = localStorage.getItem('aes_bubble_text');
            const textEl = document.getElementById('aes-editable-text');
            if (savedText && textEl) {
                textEl.innerText = savedText;
            }
        });
    </script>

</body>

</html>