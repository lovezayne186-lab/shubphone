<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat Phone UI</title>
    <!-- ÂºïÂÖ• FontAwesome ÂõæÊ†áÂ∫ì(Áî®‰∫éÊí≠ÊîæÂô®ÊåâÈíÆ) - ‰ΩøÁî®BootCDN -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.bootcdn.net/ajax/libs/boxicons/2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="CSS/widgets.css?v=2">
    <link rel="stylesheet" href="CSS/pages.css?v=2">
    <link rel="stylesheet" href="CSS/weixin.css">
    <link rel="stylesheet" href="CSS/global.css?v=2">
    <link rel="stylesheet" href="CSS/mine.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Êñ∞Â¢ûÔºöÂºïÂÖ• manifest Ë∫´‰ªΩËØÅ -->
    <link rel="manifest" href="manifest.json">

    <!-- Êñ∞Â¢ûÔºöÈíàÂØπËãπÊûúÊâãÊú∫ÁöÑÁâπÊÆä‰ºòÂæÖÔºàËãπÊûú‰∏çËØª manifestÔºåÂÆÉÁúãËøô‰∏™Ôºâ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- 3. ËÅäÂ§©ÂÆ§‰∏ìÁî®Ê†∑Âºè (Êñ∞Â¢ûËøô‰∏™) -->
    <link rel="stylesheet" href="CSS/chat-page.css">
    <style>
        /* Âº∫Âà∂ÁªôÂºπÁ™óÂä†ÊªöÂä®Êù°ÔºåÈò≤Ê≠¢ÂÜÖÂÆπÂ§™ÈïøÁúã‰∏çËßÅÊåâÈíÆ */
        .creator-body {
            max-height: 60vh !important;
            /* ÈôêÂà∂È´òÂ∫¶ */
            overflow-y: auto !important;
            /* ÂÖÅËÆ∏‰∏ä‰∏ãÊªöÂä® */
            padding-bottom: 50px !important;
            /* Â∫ïÈÉ®ÁïôÂá∫Á©∫Èöô */
        }

        /* === Âº∫Âà∂Â±ÇÁ∫ß‰øÆÂ§çË°•‰∏Å === */
        /* 1. ËÆ©ËÅäÂ§©Â§ßÁõíÂ≠êÈì∫Êª°Â±èÂπïÔºå‰ΩÜÊ≤°Êúâ‰ªª‰ΩïËæπÊ°Ü */
        #chat-view {
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            /* ÊØîÊ°åÈù¢È´ò */
            background: #fff;
            overflow: hidden;
            /* Èò≤Ê≠¢Ê∫¢Âá∫ */
        }

        /* 2. ËÆ©ÂºπÁ™óÊ∞∏ËøúÂú®ÊúÄÊúÄÊúÄÈ°∂Â±Ç */
        .modal-layer {
            z-index: 9999 !important;
            /* ÂøÖÈ°ªÊØî chat-view È´ò */
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* === ‰øÆÂ§çÂºπÁ™óÂ±ÇÁ∫ßÊâìÊû∂ÁöÑÈóÆÈ¢ò === */
        /* 1. ËÆ©ËÆæÁΩÆËèúÂçïÁ®çÂæÆ‰Ωé‰∏ÄÁÇπ */
        #settings-menu-modal {
            z-index: 9000 !important;
        }

        /* 2. ËÆ©ÂäüËÉΩÂºπÁ™óÔºàÁºñËæë„ÄÅË∫´‰ªΩ„ÄÅËÉåÊôØÔºâÊ∞∏ËøúÂéãÂú®ËèúÂçï‰∏äÈù¢ */
        #creator-modal,
        #user-persona-modal,
        #bg-setting-modal {
            z-index: 10000 !important;
        }

        /* === ÂºπÁ™óÈ°∂ÈÉ®Ê†è‰ºòÂåñ (ÁÆ≠Â§¥Èù†Â∑¶) === */
        .modal-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 50px;
            padding: 40px 10px 0 10px;
            box-sizing: border-box;
        }

        /* Â∑¶‰æßËøîÂõûÊåâÈíÆ */
        .modal-close-icon {
            width: 60px;
            /* ÁªôÂÆöÂÆΩÂ∫¶ */
            text-align: left;
            /* Âº∫Âà∂Èù†Â∑¶ */
            font-size: 32px;
            /* Â≠ó‰ΩìÊîæÂ§ßÁÇπ */
            line-height: 1;
            cursor: pointer;
            padding-left: 10px;
            /* ÂÜçÂæÄÈáå‰∏ÄÁÇπÁÇπ */
        }

        /* ‰∏≠Èó¥Ê†áÈ¢ò */
        .modal-title {
            flex: 1;
            /* Âç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ */
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        /* Âè≥‰æßÂç†‰ΩçÁ¨¶ (‰∏∫‰∫ÜËÆ©Ê†áÈ¢òÁªùÂØπÂ±Ö‰∏≠) */
        .modal-placeholder {
            width: 60px;
            /* ÂøÖÈ°ªÂíåÂ∑¶‰æßÂõæÊ†áÂÆΩÂ∫¶‰∏ÄÊ†∑ */
        }
    </style>

</head>

<body>

    <!-- ÂºÄÂ±èÂä®ÁîªÂ±Ç -->
    <div id="splash-screen" class="splash-screen">
        <img src="assets/icons/splash-screen.png" alt="Shubao Phone" class="splash-logo">
    </div>

    <div class="phone-frame">
        <div class="screen">
            <div class="notch"></div>

            <!-- --- ÊµÆÂä®Â±ÇÔºöÁä∂ÊÄÅÊ†è (‰øùÊåÅ‰∏çÂä®) --- -->
            <div class="status-bar">
                <div class="status-time" id="status-time-text">--:--</div>
                <div class="battery-icon">
                    <span class="battery-level" id="battery-num">--</span>
                </div>
            </div>
            <!-- ========== „ÄêÊ°åÈù¢Â§ßÁõíÂ≠êÂºÄÂßã„Äë ========== -->
            <div id="desktop-view">

                <div class="desktop-layout">

                    <!-- Á¨¨‰∏ÄÊéíÔºöÁªü‰∏ÄÁöÑÂ§ßÁÅ∞ÁõíÂ≠ê -->
                    <section class="desktop-section desktop-top" style="padding: 0; background: transparent;">

                        <!-- ËøôÊòØ‰∏Ä‰∏™Â§ßÁöÑÁÅ∞Ëâ≤ÂÆπÂô®ÔºåÁî®Êù•ÂåÖË£πÈáåÈù¢ÁöÑË¥¥Á∫∏ÂíåËÅäÂ§©Ê°Ü -->
                        <div class="top-unified-container">

                            <!-- Â∑¶‰æßÔºöÈáçÂè†ÁÖßÁâáÂå∫ -->
                            <div class="top-left-stickers">
                                <!-- ÁÖßÁâá 1 (ÂêéÂ±Ç) -->
                                <div class="sticker-card sticker-back" onclick="triggerWidgetUpload('sticker-1')">
                                    <img id="img-sticker-1" src="assets/icons/icon-placeholder.png" style="opacity:0;">
                                    <!-- ÈªòËÆ§ÈÄèÊòéÔºå‰∏ä‰º†ÂêéÊòæÁ§∫ -->
                                    <div class="upload-hint-text">ÁÖßÁâá1</div>
                                </div>

                                <!-- ÁÖßÁâá 2 (ÂâçÂ±ÇÔºåÂéã‰Ωè‰∏äÈù¢ÈÇ£‰∏™) -->
                                <div class="sticker-card sticker-front" onclick="triggerWidgetUpload('sticker-2')">
                                    <img id="img-sticker-2" src="assets/icons/icon-placeholder.png" style="opacity:0;">
                                    <div class="upload-hint-text">ÁÖßÁâá2</div>
                                </div>
                            </div>

                            <!-- Âè≥‰æßÔºöËÅäÂ§©/Â§ßÂõæÂå∫ -->
                            <div class="top-right-chat-card" onclick="triggerWidgetUpload('top-right-banner')">
                                <img id="img-top-right-banner" src="assets/icons/icon-placeholder.png"
                                    style="opacity:0;">
                                <div class="upload-hint-text">ÁÇπÂáª‰∏ä‰º†<br>ËÅäÂ§©Êà™Âõæ</div>
                            </div>

                        </div>
                    </section>


                    <!-- =========================================================
         Á¨¨‰∫åË°åÔºöÂ∑¶‰æß(4‰∏™APP) + Âè≥‰æß(INSÈ£éÂç°Áâá - Â∑≤‰øÆÂ§çÁªìÊûÑ)
         ========================================================= -->
                    <section class="desktop-section desktop-middle">
                        <div class="desktop-middle-left">
                            <div class="app-grid-2x2">
                                <div class="app-item-small" id="app-item-0"
                                    onclick="openChatApp(); document.getElementById('top-plus-btn').style.display='block'">
                                    <i id="app-icon-0" class="fas fa-comment"></i>
                                    <span id="app-name-0" class="app-icon-text">ÂæÆ‰ø°</span>
                                </div>
                                <div class="app-item-small" id="app-item-1" onclick="openWorldBookApp()">
                                    <i id="app-icon-1" class="fas fa-book"></i>
                                    <span id="app-name-1" class="app-icon-text">‰∏ñÁïå‰π¶</span>
                                </div>
                                <div class="app-item-small" id="app-item-2" onclick="openApp('music')">
                                    <i id="app-icon-2" class="fas fa-music"></i>
                                    <span id="app-name-2" class="app-icon-text">Èü≥‰πê</span>
                                </div>
                                <div class="app-item-small" id="app-item-3">
                                    <i id="app-icon-3" class="fas fa-hashtag"></i>
                                    <span id="app-name-3" class="app-icon-text">Â∞èÁ∫¢‰π¶</span>
                                </div>
                            </div>
                        </div>

                        <div class="desktop-middle-right">
                            <!-- INSÈ£é Ê∞õÂõ¥ÊÑüÂç°Áâá (ÁªìÊûÑ‰øÆÂ§çÁâà) -->
                            <div class="aesthetic-card">

                                <!-- 0. ËÉåÊôØÂõæÂ±Ç -->
                                <img id="img-aesthetic-bg" class="aes-bg-img" src="assets/icons/icon-placeholder.png"
                                    onclick="triggerWidgetUpload('aesthetic-bg')" style="opacity: 0;">

                                <!-- 1. È°∂ÈÉ®Êó∂Èó¥ -->
                                <div class="aes-time" id="aes-live-time">--:-- PM</div>

                                <!-- 2. ÂèØÁºñËæëÁöÑÊ∞îÊ≥°ÊñáÊ°à -->
                                <div class="aes-bubble-row">
                                    <div class="aes-bubble" contenteditable="true" id="aes-editable-text"
                                        onblur="saveAesText()">
                                        love yourself. üíï
                                    </div>
                                </div>

                                <!-- 3. ‰∏≠Èó¥Âå∫ÂüüÔºöÂ∑¶‰æßË£ÖÈ•∞ + Âè≥‰æßÁÖßÁâá (ËøôÈáå‰πãÂâçË¥¥‰π±‰∫ÜÔºåÁé∞Âú®ÊòØ‰øÆÂ§çÂ•ΩÁöÑ) -->
                                <div class="aes-middle-section">
                                    <!-- Â∑¶‰æßË£ÖÈ•∞ÔºöÁÆ≠Â§¥ÊåáÂêëÂè≥Ëæπ -->
                                    <div class="aes-decor-left">
                                        <div class="aes-icon-smiley">
                                            <i class='bx bx-happy-beaming'></i>
                                        </div>
                                        <div class="aes-icon-arrow">
                                            <i class='bx bxs-navigation'></i>
                                        </div>
                                    </div>

                                    <!-- Âè≥‰æßÁÖßÁâáÂÆπÂô® -->
                                    <div class="aes-photo-frame" onclick="triggerWidgetUpload('aesthetic-photo')">
                                        <img id="img-aesthetic-photo" src="assets/icons/icon-placeholder.png"
                                            style="opacity:0;">
                                        <div class="upload-hint-text" style="color:#666; font-size:10px;">Change</div>
                                    </div>
                                </div>

                                <!-- 4. Â∫ïÈÉ®‰º™Ë£ÖËæìÂÖ•Ê°Ü -->
                                <div class="aes-input-bar">
                                    <span class="aes-input-placeholder">Message...</span>
                                    <div class="aes-input-icons">
                                        <i class='bx bx-microphone'></i>
                                        <i class='bx bx-image'></i>
                                        <div class="aes-plus-circle"><i class='bx bx-plus'></i></div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </section>

                    <!-- =========================================================
         Á¨¨‰∏âË°åÔºöÂ∑¶‰æß(Â§ßÊñπÂùóÁÖßÁâáÂ¢ô) + Âè≥‰æß(4‰∏™APP)
         ========================================================= -->
                    <section class="desktop-section desktop-main">
                        <div class="desktop-main-left">
                            <!-- Â∑¶‰∏ãËßíÂ§ßÊñπÂùóÔºöÁÇπÂáª‰∏ä‰º†ÁÖßÁâá -->
                            <div class="main-widget-card" onclick="triggerWidgetUpload('main-widget')">
                                <!-- Ê≤°ÂõæÊó∂ÁöÑÂç†‰ΩçÁ¨¶ -->
                                <div class="main-widget-placeholder">
                                    <i class='bx bx-plus'></i>
                                </div>
                                <!-- ÂõæÁâáÊú¨‰Ωì -->
                                <img id="img-main-widget" src="" style="display:none;"
                                    onload="this.style.display='block'; this.previousElementSibling.style.display='none'">
                            </div>
                        </div>

                        <div class="desktop-main-right">
                            <div class="app-grid-2x2">
                                <div class="app-item-small" id="app-item-4">
                                    <i id="app-icon-4" class="fas fa-gamepad"></i>
                                    <span id="app-name-4" class="app-icon-text">Ê∏∏Êàè</span>
                                </div>

                                <div class="app-item-small" id="app-item-5">
                                    <i id="app-icon-5" class="fas fa-envelope"></i>
                                    <span id="app-name-5" class="app-icon-text">‰ø°ÁÆ±</span>
                                </div>
                                <div class="app-item-small" id="app-item-6">
                                    <i id="app-icon-6" class="fas fa-truck"></i>
                                    <span id="app-name-6" class="app-icon-text">È©øÁ´ô</span>
                                </div>
                                <div class="app-item-small" id="app-item-7">
                                    <i id="app-icon-7" class="fas fa-ellipsis-h"></i>
                                    <span id="app-name-7" class="app-icon-text">Êõ¥Â§ö</span>
                                </div>
                            </div>
                        </div>
                    </section>


                </div>


                <!-- --- ÊµÆÂä®Â±ÇÔºöDock (‰øùÊåÅ‰∏çÂä®) --- -->
                <!-- --- ÊµÆÂä®Â±ÇÔºöDock (‰øùÊåÅ‰∏çÂä®) --- -->
                <div class="dock">
                    <!-- 1. ËÆæÁΩÆÊåâÈíÆ -->
                    <div class="dock-item" onclick="openApp('settings')">
                        <div class="dock-icon-img">‚öôÔ∏è</div>
                        <span>ËÆæÁΩÆ</span>
                    </div>

                    <!-- 2. TODOÂ∫îÁî® -->
                    <div class="dock-item" onclick="openApp('todo')">
                        <div class="dock-icon-img">‚úì</div>
                        <span>TODO</span>
                    </div>

                    <!-- 3. Â§ñËßÇÊåâÈíÆ -->
                    <div class="dock-item" onclick="openApp('appearance')">
                        <div class="dock-icon-img">üé®</div>
                        <span>Â§ñËßÇ</span>
                    </div>
                </div>

                <!-- ÈÄöÁî®ÁöÑ App ÂÖ®Â±èÂÆπÂô® -->
                <div id="app-window" class="app-window">
                    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
                    <div class="app-header">
                        <!-- 1. ËøîÂõûÊåâÈíÆÔºàÂ¢ûÂä†‰∫Ü‰∏Ä‰∏™ÈöêËóèÂä†Âè∑ÁöÑÂä®‰ΩúÔºâ -->
                        <div class="back-btn"
                            onclick="closeApp(); document.getElementById('top-plus-btn').style.display='none'">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
                            </svg>
                            <span>ËøîÂõû</span>
                        </div>

                        <div class="app-title" id="app-title-text">Â∫îÁî®ÂêçÁß∞</div>

                        <!-- 2. ËøôÈáåÂ∞±ÊòØ‰Ω†Ë¶ÅÁöÑÂä†Âè∑ÔºÅÈªòËÆ§ÈöêËóè -->
                        <div id="top-plus-btn"
                            style="width: 40px; text-align: right; cursor: pointer; display: none; color: #000;"
                            onclick="openCreator()">
                            <i class="fas fa-plus" style="font-size: 18px;"></i>
                        </div>
                    </div>

                    <!-- App ÂÜÖÂÆπÂå∫Âüü (Âä®ÊÄÅÂèòÂåñ) -->
                    <div class="app-content" id="app-content-area">
                        <!-- ÁÇπÂáª‰∏çÂêåÁöÑÂõæÊ†áÔºåËøôÈáåÁöÑÂÜÖÂÆπ‰ºöÂèò -->
                    </div>
                </div>
                <!-- 2. ÈÄöÁî®ËßíËâ≤ÂºπÁ™ó (Èü©Á≥ªÈªëÁôΩÁÆÄÁ∫¶È£é) -->
                <div id="creator-modal" class="modal-layer bg-gray-50 flex flex-col h-full" style="display: none; z-index: 10000; background-color: rgb(249 250 251);">
                    <!-- Top Header -->
                    <div class="flex justify-between items-center px-6 pt-12 pb-4 bg-white/0">
                        <div class="modal-close-icon text-3xl font-light cursor-pointer" onclick="closeCreator()">
                            <i class='bx bx-chevron-left text-4xl text-black'></i>
                        </div>
                        <div class="text-lg font-bold text-black tracking-wide" id="modal-title">ÂàõÂª∫ËßíËâ≤</div>
                        <div class="w-8"></div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto px-6 pb-32">
                        <!-- Avatar -->
                        <div class="flex flex-col items-center mt-4 mb-8">
                            <div class="relative group cursor-pointer" onclick="document.getElementById('ai-avatar-file').click()">
                                <div class="w-24 h-24 rounded-full border-2 border-black overflow-hidden bg-white">
                                    <img id="avatar-preview" src="assets/chushitouxiang.jpg" class="w-full h-full object-cover">
                                </div>
                                <div class="absolute bottom-0 right-0 bg-black text-white rounded-full p-1 border-2 border-white flex items-center justify-center w-8 h-8">
                                    <i class='bx bx-camera text-sm'></i>
                                </div>
                                <input type="file" id="ai-avatar-file" accept="image/*" class="hidden" onchange="previewAvatar(this)">
                            </div>
                            <p class="mt-2 text-xs text-gray-500 font-medium">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</p>
                        </div>

                        <!-- Card 1: Basic Info -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] overflow-hidden mb-6">
                            <!-- Name -->
                            <div class="flex justify-between items-center p-4 border-b border-black">
                                <label class="font-bold text-black text-sm w-20">ËßíËâ≤ÂêçÁß∞</label>
                                <input type="text" id="ai-name" placeholder="ÂêçÂ≠ó" style="background-color: transparent !important;" class="flex-1 text-right outline-none border-none bg-transparent text-gray-800 placeholder-gray-400 appearance-none focus:ring-0">
                            </div>
                            <!-- Worldbook -->
                            <div class="flex justify-between items-center p-4 border-b border-black">
                                <label class="font-bold text-black text-sm w-24">ÂÖ≥ËÅî‰∏ñÁïå‰π¶</label>
                                <div class="flex items-center gap-2 flex-1 justify-end">
                                    <select id="ai-worldbook-select" class="text-right outline-none border-none bg-transparent text-gray-800 appearance-none pr-6 relative z-10 w-full focus:ring-0" style="direction: rtl;">
                                        <option value="">Âä†ËΩΩ‰∏≠...</option>
                                    </select>
                                </div>
                            </div>
                            <!-- User Persona Preset -->
                            <div class="flex justify-between items-center p-4">
                                <label class="font-bold text-black text-sm w-24">ÊàëÁöÑË∫´‰ªΩÈ¢ÑËÆæ</label>
                                <div class="flex items-center gap-2 flex-1 justify-end">
                                    <select id="user-persona-preset-select" class="text-right outline-none border-none bg-transparent text-gray-800 appearance-none pr-6 relative z-10 w-full focus:ring-0" style="direction: rtl;">
                                        <option value="">‰∏ç‰ΩøÁî®È¢ÑËÆæ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: Personality -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col h-40 mb-6 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-black text-sm">ÊÄßÊ†ºËÆæÂÆö / Prompt</label>
                            </div>
                            <textarea id="ai-personality" style="background-color: transparent !important;" class="flex-1 w-full outline-none resize-none bg-transparent text-sm leading-relaxed text-gray-800 placeholder-gray-400 border-none focus:ring-0" placeholder="‰æãÂ¶ÇÔºöÂÇ≤Â®á„ÄÅÊØíËàå..."></textarea>
                        </div>

                        <!-- Card 3: Chat Style -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col h-40 mb-6 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-black text-sm">ËÅäÂ§©È£éÊ†º</label>
                            </div>
                            <textarea id="ai-style" style="background-color: transparent !important;" class="flex-1 w-full outline-none resize-none bg-transparent text-sm leading-relaxed text-gray-800 placeholder-gray-400 border-none focus:ring-0" placeholder="‰æãÂ¶ÇÔºöÂñúÊ¨¢ÂèëÈ¢úÊñáÂ≠ó..."></textarea>
                        </div>

                        <!-- Card 4: Schedule -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col h-40 mb-6 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-black text-sm">‰ΩúÊÅØË°®</label>
                            </div>
                            <textarea id="ai-schedule" style="background-color: transparent !important;" class="flex-1 w-full outline-none resize-none bg-transparent text-sm leading-relaxed text-gray-800 placeholder-gray-400 border-none focus:ring-0" placeholder="‰æãÂ¶ÇÔºö7:00 Ëµ∑Â∫ä..."></textarea>
                        </div>

                        <!-- Card 5: Video Album -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col mb-6 relative">
                            <div class="flex justify-between items-center mb-4">
                                <label class="font-bold text-black text-sm">ËßÜÈ¢ëÈÄöËØùÁõ∏ÂÜå</label>
                                <button onclick="document.getElementById('creator-video-album-file').click()" class="bg-black text-white text-xs px-3 py-1.5 rounded-full font-bold">
                                    <i class='bx bx-plus mr-1'></i>Ê∑ªÂä†
                                </button>
                                <input type="file" id="creator-video-album-file" accept="image/*" class="hidden" onchange="handleCreatorVideoAlbumFile(this)">
                            </div>
                            <div id="creator-video-album-list" class="flex flex-wrap gap-2">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Buttons -->
                    <div class="absolute bottom-0 left-0 w-full px-6 pb-8 pt-6 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent">
                        <div class="flex gap-4">
                            <button class="flex-1 h-12 bg-white text-black border border-black rounded-full font-bold text-sm hover:opacity-80 transition-opacity" onclick="closeCreator()">
                                ÂèñÊ∂à
                            </button>
                            <button class="flex-1 h-12 bg-black text-white rounded-full font-bold text-sm hover:opacity-80 transition-opacity shadow-lg" onclick="saveCharacterData()">
                                ‰øùÂ≠ò
                            </button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- ========== „ÄêÊ°åÈù¢Â§ßÁõíÂ≠êÁªìÊùü„Äë ========== -->


            <!-- ========== „ÄêËÅäÂ§©Â§ßÁõíÂ≠êÔºàÊúÄÁªàÊó†Â£≥‰øÆÊ≠£ÁâàÔºâ„Äë ========== -->
            <div id="chat-view" style="display: none;">

                <!-- === 1. È°∂ÈÉ®Áä∂ÊÄÅÊ†è (‰º™Ë£ÖÊàêÊâãÊú∫Áä∂ÊÄÅÊ†è) === -->
                <div class="status-bar"
                    style="position: absolute; top: 0; width: 100%; z-index: 60; background: transparent;">
                    <div class="status-time" id="status-time-text-chat" style="color: #000;">--:--</div>
                    <div class="battery-icon">
                        <span class="battery-level" id="battery-num-chat" style="color: #000;">--</span>
                    </div>
                </div>

                <!-- === 2. ËÅäÂ§©ÂÆ§‰∏ª‰ΩìÂÜÖÂÆπ === -->
                <div id="chat-room-layer" class="custom-chat-background"
                    style="display: block; width: 100%; height: 100%; background: #f5f5f5;">

                    <div class="chat-room-header custom-top-bar"
                        style="padding-top: 40px; height: 80px; align-items: flex-end; padding-bottom: 10px;">
                        <div class="back-btn" onclick="backToList()">
                            <i class="fas fa-chevron-left"></i>
                            <span>ÂæÆ‰ø°</span>
                        </div>
                        <div class="chat-room-title-wrap">
                            <div class="chat-room-title" id="current-chat-name" style="margin-bottom: 5px;">Âä†ËΩΩ‰∏≠...</div>
                            <div class="status-heart-btn" id="status-heart-btn" onclick="openStatusMonitorPanel()">
                                <i class='bx bxs-heart'></i>
                            </div>
                        </div>
                        <div class="chat-room-menu" onclick="openChatSettings()" style="margin-bottom: 5px;">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                    </div>

                    <div id="status-monitor-modal" class="status-monitor-modal" style="display: none;"
                        onclick="handleStatusMonitorMaskClick(event)">
                        <div class="status-monitor-card">
                            <div class="status-history-toggle-btn" onclick="event.stopPropagation(); toggleStatusHistoryView();">
                                <i class='bx bx-history'></i>
                            </div>
                            <div class="status-monitor-header">
                                <div class="status-monitor-avatar">
                                    <img id="status-monitor-avatar-img" src="assets/chushitouxiang.jpg">
                                </div>
                                <div class="status-monitor-header-right">
                                    <div id="status-monitor-time" class="status-monitor-time">--Êúà--Êó• --:--</div>
                                    <div class="status-monitor-divider"></div>
                                    <div id="status-monitor-location" class="status-monitor-location">Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...</div>
                                </div>
                            </div>

                            <div class="status-monitor-section status-monitor-stats">
                                <div class="status-monitor-text-row">
                                    <div class="status-monitor-text-label">ÂøÉÊÉÖ</div>
                                    <div class="status-monitor-text-value" id="status-mood-text">Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...</div>
                                </div>
                                <div class="status-monitor-text-row">
                                    <div class="status-monitor-text-label">ÊÄßÂπªÊÉ≥</div>
                                    <div class="status-monitor-text-value status-monitor-fantasy"
                                        id="status-fantasy-text">Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">Â•ΩÊÑüÂ∫¶</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-favorability-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-favorability-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">ÂêÉÈÜãÂÄº</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-jealousy-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-jealousy-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">Âç†ÊúâÊ¨≤</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-possessiveness-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-possessiveness-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">ÊÄßÊ¨≤ÂÄº</div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" id="status-lust-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-lust-text">--</div>
                                </div>

                                <div class="status-progress-item">
                                    <div class="status-progress-label">ÂøÉÁéá</div>
                                    <div class="status-progress-bar status-heart-bar">
                                        <div class="status-progress-fill" id="status-heart-bar"></div>
                                    </div>
                                    <div class="status-progress-value" id="status-heart-text">-- BPM</div>
                                </div>
                            </div>

                            <div class="status-monitor-section status-monitor-inner">
                                <div class="status-inner-title" id="status-inner-title">Ê≠§ÂàªÂøÉÂ£∞</div>
                                <div class="status-inner-content" id="status-thought-text">
                                    Ê≠£Âú®ÂêåÊ≠•ÁîüÂëΩ‰ΩìÂæÅ...
                                </div>
                            </div>
                            <div id="status-history-view" class="status-history-view" onclick="event.stopPropagation();">
                                <div class="status-history-header">
                                    <div class="status-history-back" onclick="toggleStatusHistoryView();">
                                        <i class='bx bx-chevron-left'></i>
                                        <span>ËøîÂõû</span>
                                    </div>
                                    <div class="status-history-title">Áä∂ÊÄÅÊó•Âøó</div>
                                    <div class="status-history-header-spacer"></div>
                                </div>
                                <div id="status-history-list" class="status-history-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰∏≠Èó¥Ê∂àÊÅØÂå∫ -->
                    <div class="chat-room-body custom-chat-area" id="chat-history" style="height: calc(100% - 140px);">
                        <!-- Ê∂àÊÅØ‰ºöÊèíÂú®ËøôÈáå -->
                    </div>

                    <!-- Â∫ïÈÉ®ËæìÂÖ•Ê†è (‰øÆÊîπÂêéÔºöÂåÖÂê´ÂºïÁî®Êù°) -->
                    <div style="background: #f7f7f7; border-top: 1px solid #dcdcdc;">

                        <!-- Êñ∞Â¢ûÔºöÂºïÁî®ÊòæÁ§∫Êù° (ÈªòËÆ§ÈöêËóè) -->
                        <div id="quote-bar"
                            style="display:none; padding: 8px 15px; align-items: center; background:#f5f5f5; border-bottom:1px solid #e5e5e5;">
                            <div class="quote-text" id="quote-content"
                                style="flex:1; font-size:12px; color:#666; border-left: 3px solid #888; padding-left:8px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                                ÂºïÁî®ÂÜÖÂÆπ...
                            </div>
                            <div class="quote-close" onclick="cancelQuote()"
                                style="padding:0 10px; font-size:18px; color:#999; cursor:pointer;">√ó</div>
                        </div>

                        <!-- ÂéüÊù•ÁöÑÂ∫ïÈÉ®Êìç‰ΩúÊ†è (ÂéªÊéâ‰∏äËæπÊ°ÜÔºåÂõ†‰∏∫Áà∂Á∫ßÂä†‰∫Ü) -->
                        <div class="chat-room-footer custom-bottom-bar new-layout">
                            <div class="footer-icon-btn" id="more-btn">
                                <i class="fas fa-chevron-circle-up" style="transform: rotate(90deg);"></i>
                            </div>
                            <div class="input-wrapper">
                                <input type="text" id="msg-input" class="new-input-field" placeholder="ÂèëÊ∂àÊÅØ...">
                                <div id="quick-emoji-btn" class="embedded-emoji-btn">
                                    <i class="far fa-smile"></i>
                                </div>
                            </div>
                            <div class="footer-icon-btn circle-btn ai-btn" onclick="triggerAI()">
                                <i class="bx bx-heart"></i>
                            </div>
                            <div class="footer-icon-btn send-arrow-btn" onclick="sendMessage()">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                        </div>

                        <div id="chat-more-panel" class="chat-more-panel">
                            <div class="chat-more-pages" id="chat-more-pages"></div>
                            <div class="chat-more-dots" id="chat-more-dots"></div>
                            <div id="chat-sticker-panel" class="chat-sticker-panel">
                                <div class="sticker-tabs">
                                    <div class="sticker-tab active" data-type="mine">ÊàëÁöÑ</div>
                                    <div class="sticker-tab" data-type="his">‰ªñÁöÑ</div>
                                    <div class="sticker-tab" data-type="general">ÈÄöÁî®</div>
                                    <div class="sticker-tab-add" id="sticker-add-btn">+</div>
                                </div>
                                <div class="sticker-grid" id="sticker-grid"></div>
                            </div>
                        </div>
                    </div>
                    <!-- === Êñ∞Â¢ûÔºöÂ§öÈÄâÂ∫ïÈÉ®Â∑•ÂÖ∑Ê†è === -->
                    <div id="multi-select-bar">
                        <div class="multi-btn" onclick="performMultiAction('forward')">
                            <i class="fas fa-share"></i>
                            <span>ËΩ¨Âèë</span>
                        </div>
                        <div class="multi-btn" onclick="performMultiAction('fav')">
                            <i class="fas fa-cube"></i> <!-- ÂæÆ‰ø°Êî∂ËóèÊòØ‰∏™Á´ãÊñπ‰ΩìÔºåËøôÈáåÁî®cubeÊàñËÄÖstar -->
                            <span>Êî∂Ëóè</span>
                        </div>
                        <div class="multi-btn delete-btn" onclick="performMultiAction('delete')">
                            <i class="fas fa-trash"></i>
                            <span>Âà†Èô§</span>
                        </div>
                    </div>
                    <input type="file" id="chat-image-uploader" accept="image/*" multiple style="display:none;">

                </div>

                <div id="voice-call-overlay" class="voice-call-overlay" style="display:none;">
                    <div class="voice-call-header">
                        <div id="voice-call-minimize" class="voice-call-minimize">
                            <i class='bx bx-chevron-down'></i>
                        </div>
                    </div>
                    <div class="voice-call-main">
                        <div class="voice-call-avatar-box">
                            <img id="voice-call-avatar" class="voice-call-avatar" src="assets/chushitouxiang.jpg"
                                alt="">
                        </div>
                        <div class="voice-call-chat-wrapper">
                            <div id="call-chat-container" class="call-chat-container"></div>
                        </div>
                    </div>
                    <div class="voice-call-footer">
                        <div id="voice-call-status" class="voice-call-status-text">Á≠âÂæÖÂØπÊñπÊé•ÂèóÈÇÄËØ∑...</div>
                        <div id="voice-call-input-row" class="voice-call-input-row" style="display:none;">
                            <input id="voice-call-input" class="voice-call-input" type="text" placeholder="Âú®ÈÄöËØù‰∏≠ÂèëÊ∂àÊÅØ...">
                            <button id="voice-call-send" class="voice-call-send-btn">ÂèëÈÄÅ</button>
                        </div>
                        <div class="voice-call-buttons">
                            <button id="voice-call-mic-btn" class="call-btn call-btn-small">
                                <i class='bx bx-microphone'></i>
                            </button>
                            <button id="voice-call-hangup-btn" class="call-btn call-btn-hangup">
                                <i class='bx bx-phone-off'></i>
                            </button>
                            <button id="voice-call-speaker-btn" class="call-btn call-btn-small">
                                <i class='bx bx-volume-full'></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="call-float-window" class="call-float-window" style="display:none;">
                    <span>ÈÄöËØù‰∏≠...</span>
                </div>

                <div id="location-share-float-window" class="location-share-float-window" style="display:none;">
                    <span id="location-share-float-text">‰ΩçÁΩÆÂÖ±‰∫´‰∏≠...</span>
                </div>

                <!-- =======================================================
                     === 3. ÂºπÁ™óÂå∫ (ÊîæÂú®ËøôÈáåÔºå‰øùËØÅÂú®ËÅäÂ§©ÂÆ§‰πã‰∏ä) ===
                     ======================================================= -->

                <div id="sticker-import-modal" class="modal-layer" style="display:none; background: rgba(0,0,0,0.4);">
                    <div
                        style="margin:auto; width:90%; max-width:320px; background:#fff; border-radius:12px; padding:15px; box-sizing:border-box;">
                        <div style="font-size:16px; font-weight:600; margin-bottom:8px;">ÂØºÂÖ•Ë°®ÊÉÖÂåÖ</div>
                        <div style="margin-bottom:8px; font-size:14px;">
                            <label for="sticker-import-category">ÂØºÂÖ•Âà∞ÂàÜÁªÑÔºö</label>
                            <select id="sticker-import-category"
                                style="width:100%; margin-top:4px; padding:6px 8px; font-size:14px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                                <option value="mine">ÊàëÁöÑË°®ÊÉÖ</option>
                                <option value="his">‰ªñÁöÑË°®ÊÉÖ</option>
                                <option value="general">ÈÄöÁî®Ë°®ÊÉÖ</option>
                            </select>
                        </div>
                        <div style="margin-bottom:10px;">
                            <textarea id="sticker-import-text" placeholder="ÊØèË°å‰∏ÄÊù°ÔºöÂêçÁß∞: URL"
                                style="width:100%; height:120px; box-sizing:border-box; border:1px solid #ddd; border-radius:6px; padding:8px; font-size:13px; resize:vertical;"></textarea>
                        </div>
                        <div style="text-align:right;">
                            <button
                                style="padding:6px 10px; margin-right:8px; border:none; background:#f0f0f0; border-radius:4px; font-size:13px;"
                                onclick="closeStickerImportModal()">ÂèñÊ∂à</button>
                            <button
                                style="padding:6px 12px; border:none; background:#07c160; color:#fff; border-radius:4px; font-size:13px;"
                                onclick="confirmStickerImport()">ÂØºÂÖ•</button>
                        </div>
                    </div>
                </div>

                <!-- A. ËÅäÂ§©ËÆæÁΩÆËèúÂçï (Âè≥‰∏äËßí‰∏â‰∏™ÁÇπ) -->
                <div id="settings-menu-modal" class="modal-layer" style="display: none; background: rgba(0,0,0,0.5);">
                    <!-- ÁÇπÂáªÂçäÈÄèÊòéËÉåÊôØÂÖ≥Èó≠ -->
                    <div style="position:absolute; width:100%; height:100%;" onclick="closeSettingsMenu()"></div>

                    <!-- ËèúÂçïÂÜÖÂÆπ (‰ªéÂ∫ïÈÉ®ÊªëÂá∫) -->
                    <div class="modal-content settings-list-layout"
                        style="position: absolute; bottom: 0; width: 100%; border-radius: 20px 20px 0 0;">
                        <div class="modal-header-bar">
                            <div class="modal-close-icon" onclick="closeSettingsMenu()">√ó</div>
                            <div class="modal-title">ËÅäÂ§©‰ø°ÊÅØ</div>
                            <div class="modal-placeholder"></div>
                        </div>

                        <div class="settings-group" onclick="openCharacterEditor()">
                            <div class="profile-card">
                                <img id="menu-role-avatar" src="assets/chushitouxiang.jpg" class="profile-avatar">
                                <div class="profile-info">
                                    <div class="profile-name" id="menu-role-name">ËßíËâ≤Âêç</div>
                                    <div class="profile-desc" id="menu-role-desc">ÁÇπÂáªÊü•ÁúãÊ°£Ê°à...</div>
                                </div>
                                <div class="chevron">‚Ä∫</div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-item" onclick="openUserPersonaModal()">
                                <div class="item-label">ÊàëÁöÑÂΩìÂâçË∫´‰ªΩ</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" style="cursor: default; height:auto;">
                                <div style="flex:1;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div class="item-label">ÂÖÅËÆ∏ËßíËâ≤ÂèëÊúãÂèãÂúà</div>
                                        <label class="switch">
                                            <input type="checkbox" id="setting-moments-posting-enabled"
                                                onchange="saveChatSettings()">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-item" style="cursor: default; height:auto;">
                                <div style="flex:1;">
                                    <div class="item-label">Áü≠ÊúüËÆ∞ÂøÜÊù°Êï∞</div>
                                    <div
                                        style="margin-top:4px; display:flex; justify-content:space-between; align-items:center;">
                                        <input type="number" id="setting-memory-limit" value="50"
                                            onchange="saveChatSettings()"
                                            style="width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 2px;">
                                        <span style="font-size: 10px; color: #999; margin-left:10px;">50~100
                                            Êù°‰∏∫Êé®ËçêËåÉÂõ¥</span>
                                    </div>
                                </div>
                            </div>

                            <div class="settings-item" style="cursor: default; height:auto;">
                                <div style="flex:1;">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div class="item-label">Ëá™Âä®ÊÄªÁªì</div>
                                        <label class="switch">
                                            <input type="checkbox" id="setting-auto-summary-switch"
                                                onchange="toggleSummaryInput(); saveChatSettings();">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div id="setting-summary-freq-box"
                                        style="display: none; margin-top: 8px; align-items: center; justify-content: space-between;">
                                        <span style="font-size: 12px; color: #666;">ÊØèÂ§öÂ∞ëÊù°ÊÄªÁªì‰∏ÄÊ¨°:</span>
                                        <input type="number" id="setting-summary-freq" value="20"
                                            onchange="saveChatSettings()"
                                            style="width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                            </div>

                            <div class="settings-item" onclick="openMemoryArchiveModal()">
                                <div class="item-label">ËÆ∞ÂøÜÊ°£Ê°à</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" onclick="openCallLogModal()">
                                <div class="item-label">ÈÄöËØùËÆ∞ÂΩï</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" onclick="openBgSettingModal()">
                                <div class="item-label">ËÅäÂ§©ËÉåÊôØ</div>
                                <div class="chevron">‚Ä∫</div>
                            </div>

                            <div class="settings-item" style="cursor: default; height:auto; border-bottom:none;">
                                <div style="flex:1;">
                                    <div class="item-label" style="margin-bottom: 5px;">Ëá™ÂÆö‰πâÊ∞îÊ≥°Ê†∑Âºè (CSS)</div>
                                    <div
                                        style="background: #ededed; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                        <div id="bubble-preview">
                                            <div style="display:flex; align-items:flex-start; margin-bottom:8px;">
                                                    <div class="preview-avatar-left"
                                                    style="width: 32px; height: 32px; border-radius: 4px; overflow:hidden; background:#ccc; flex-shrink:0; margin-right:8px;">
                                                    <img src="assets/chushitouxiang.jpg"
                                                        style="width:100%; height:100%; object-fit:cover;">
                                                </div>
                                                <div class="preview-bubble-left"
                                                    style="background: #ffffff; padding: 8px 12px; border-radius: 4px; font-size: 14px; max-width: 70%; color: #000;">
                                                    AIÔºöHello
                                                </div>
                                            </div>
                                            <div
                                                style="display:flex; align-items:flex-start; justify-content:flex-end;">
                                                <div class="preview-bubble-right"
                                                    style="background: #95ec69; padding: 8px 12px; border-radius: 4px; font-size: 14px; max-width: 70%; color: #000; margin-right:8px;">
                                                    ÊàëÔºöHello
                                                </div>
                                                <div class="preview-avatar-right"
                                                    style="width: 32px; height: 32px; border-radius: 4px; overflow:hidden; background:#ccc; flex-shrink:0;">
                                                    <img src="assets/chushitouxiang.jpg"
                                                        style="width:100%; height:100%; object-fit:cover;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <textarea id="setting-bubble-css"
                                        placeholder="ËæìÂÖ•CSS‰ª£Á†ÅÔºå‰æãÂ¶Ç: background: pink; color: white;"
                                        style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 5px; font-size: 12px; font-family: monospace;"
                                        oninput="updateBubblePreview(); saveChatSettings();"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-item text-danger" onclick="clearChatHistory()">
                                <div class="item-label" style="color: #ff3b30;">
                                    Ê∏ÖÁ©∫‰∏éTAÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="settings-item text-danger" onclick="deleteCurrentCharacter()">
                                <div class="item-label" style="color: #ff3b30; font-weight: bold;">
                                    Âà†Èô§ÂΩìÂâçËßíËâ≤
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =======================================================
     ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è ËØ∑Áî®ËøôÊÆµ‰ª£Á†Å ÊõøÊç¢ÊéâÂéüÊù•ÁöÑ B ÈÉ®ÂàÜ (editor-modal-deleted) ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
     ======================================================= -->

                <!-- B. ËßíËâ≤ÁºñËæëÂºπÁ™ó (Èü©Á≥ªÈªëÁôΩÁÆÄÁ∫¶È£é) -->
                <div id="editor-modal" class="modal-layer bg-gray-50 flex flex-col h-full" style="display: none; background-color: rgb(249 250 251);">
                    <!-- Header -->
                    <div class="flex justify-between items-center px-6 pt-12 pb-4 bg-white/0">
                        <div class="modal-close-icon text-3xl font-light cursor-pointer" onclick="closeEditor()">
                            <i class='bx bx-chevron-left text-4xl text-black'></i>
                        </div>
                        <div class="text-lg font-bold text-black tracking-wide">ÁºñËæëËßíËâ≤</div>
                        <div class="w-8"></div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto px-6 pb-32">
                        <!-- Avatar -->
                        <div class="flex flex-col items-center mt-4 mb-8">
                            <div class="relative group cursor-pointer" onclick="document.getElementById('edit-ai-avatar-file').click()">
                                <div class="w-24 h-24 rounded-full border-2 border-black overflow-hidden bg-white">
                                    <img id="edit-avatar-preview" src="assets/chushitouxiang.jpg" class="w-full h-full object-cover">
                                </div>
                                <div class="absolute bottom-0 right-0 bg-black text-white rounded-full p-1 border-2 border-white flex items-center justify-center w-8 h-8">
                                    <i class='bx bx-camera text-sm'></i>
                                </div>
                                <input type="file" id="edit-ai-avatar-file" accept="image/*" class="hidden" onchange="previewEditAvatar(this)">
                            </div>
                            <p class="mt-2 text-xs text-gray-500 font-medium">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</p>
                        </div>

                        <!-- Card 1: Basic Info -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] overflow-hidden mb-6">
                            <!-- Name -->
                            <div class="flex justify-between items-center p-4 border-b border-black">
                                <label class="font-bold text-black text-sm w-20">ËßíËâ≤ÂêçÁß∞</label>
                                <input type="text" id="edit-ai-name" style="background-color: transparent !important;" class="flex-1 text-right outline-none border-none bg-transparent text-gray-800 placeholder-gray-400 appearance-none focus:ring-0">
                            </div>
                            <!-- Remark -->
                            <div class="flex justify-between items-center p-4 border-b border-black">
                                <label class="font-bold text-black text-sm w-20">ËßíËâ≤Â§áÊ≥®</label>
                                <input type="text" id="edit-ai-remark" placeholder="ÊòæÁ§∫Âú®ËÅäÂ§©ÈáåÁöÑÂ§áÊ≥®" style="background-color: transparent !important;" class="flex-1 text-right outline-none border-none bg-transparent text-gray-800 placeholder-gray-400 appearance-none focus:ring-0">
                            </div>
                            <!-- Worldbook -->
                            <div class="flex justify-between items-center p-4">
                                <label class="font-bold text-black text-sm w-24">ÂÖ≥ËÅî‰∏ñÁïå‰π¶</label>
                                <div class="flex items-center gap-2 flex-1 justify-end">
                                    <select id="edit-ai-worldbook-select" class="text-right outline-none border-none bg-transparent text-gray-800 appearance-none pr-6 relative z-10 w-full focus:ring-0" style="direction: rtl;">
                                        <option value="">Âä†ËΩΩ‰∏≠...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: Personality -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col h-40 mb-6 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-black text-sm">ÊÄßÊ†ºËÆæÂÆö / Prompt</label>
                            </div>
                            <textarea id="edit-ai-personality" style="background-color: transparent !important;" class="flex-1 w-full outline-none resize-none bg-transparent text-sm leading-relaxed text-gray-800 placeholder-gray-400 border-none focus:ring-0"></textarea>
                        </div>

                        <!-- Card 3: Chat Style (Moved & Changed to Textarea) -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col h-40 mb-6 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-black text-sm">ËÅäÂ§©È£éÊ†º</label>
                            </div>
                            <textarea id="edit-ai-style" style="background-color: transparent !important;" class="flex-1 w-full outline-none resize-none bg-transparent text-sm leading-relaxed text-gray-800 placeholder-gray-400 border-none focus:ring-0"></textarea>
                        </div>

                        <!-- Card 4: Schedule -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col h-40 mb-6 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-black text-sm">‰ΩúÊÅØË°®</label>
                            </div>
                            <textarea id="edit-ai-schedule" style="background-color: transparent !important;" class="flex-1 w-full outline-none resize-none bg-transparent text-sm leading-relaxed text-gray-800 placeholder-gray-400 border-none focus:ring-0"></textarea>
                        </div>

                        <!-- Card 4: Video Album -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col mb-6 relative">
                            <div class="flex justify-between items-center mb-4">
                                <label class="font-bold text-black text-sm">ËßÜÈ¢ëÈÄöËØùÁõ∏ÂÜå</label>
                                <button onclick="document.getElementById('edit-video-album-file').click()" class="bg-black text-white text-xs px-3 py-1.5 rounded-full font-bold">
                                    <i class='bx bx-plus mr-1'></i>Ê∑ªÂä†
                                </button>
                                <input type="file" id="edit-video-album-file" accept="image/*" class="hidden" onchange="handleEditVideoAlbumFile(this)">
                            </div>
                            <div id="edit-video-album-list" class="flex flex-wrap gap-2">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Buttons -->
                    <div class="absolute bottom-0 left-0 w-full px-6 pb-8 pt-6 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent">
                        <div class="flex gap-4">
                            <button class="flex-1 h-12 bg-white text-black border border-black rounded-full font-bold text-sm hover:opacity-80 transition-opacity" onclick="closeEditor()">
                                ÂèñÊ∂à
                            </button>
                            <button class="flex-1 h-12 bg-black text-white rounded-full font-bold text-sm hover:opacity-80 transition-opacity shadow-lg" onclick="saveEditResult()">
                                ‰øùÂ≠ò‰øÆÊîπ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- =======================================================
     ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è ËØ∑ÊääËøôÈÉ®ÂàÜÂÆåÊï¥Â§çÂà∂ÔºåÊõøÊç¢ÊéâÂéüÊù•ÁÆÄÈôãÁöÑ C Âíå D ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
     ======================================================= -->

                <!-- C. ÊàëÁöÑË∫´‰ªΩÂºπÁ™ó (Èü©Á≥ªÈªëÁôΩÁÆÄÁ∫¶È£é) -->
                <div id="user-persona-modal" class="modal-layer bg-gray-50 flex flex-col h-full" style="display: none; z-index: 10000; background-color: rgb(249 250 251);">
                    <!-- Top Header -->
                    <div class="flex justify-between items-center px-6 pt-12 pb-4 bg-white/0">
                        <div class="modal-close-icon text-3xl font-light cursor-pointer" onclick="closeSubModal('user-persona-modal')">
                            <i class='bx bx-chevron-left text-4xl text-black'></i>
                        </div>
                        <div class="text-lg font-bold text-black tracking-wide">ÊàëÁöÑË∫´‰ªΩ</div>
                        <div class="w-8"></div> <!-- Placeholder for center alignment -->
                    </div>

                    <!-- Scrollable Content Area -->
                    <div class="flex-1 overflow-y-auto px-6 pb-32">
                        
                        <!-- 1. Avatar Section -->
                        <div class="flex flex-col items-center mt-4 mb-8">
                            <div class="relative group cursor-pointer" onclick="document.getElementById('user-avatar-input').click()">
                                <div class="w-24 h-24 rounded-full border-2 border-black overflow-hidden bg-white">
                                    <img id="user-settings-avatar" src="assets/chushitouxiang.jpg" class="w-full h-full object-cover">
                                </div>
                                <div class="absolute bottom-0 right-0 bg-black text-white rounded-full p-1 border-2 border-white flex items-center justify-center w-8 h-8">
                                     <i class='bx bx-camera text-sm'></i>
                                </div>
                                <input type="file" id="user-avatar-input" hidden onchange="previewUserAvatar(this)">
                            </div>
                            <p class="mt-2 text-xs text-gray-500 font-medium">ÁÇπÂáªÊõ¥Êç¢Â§¥ÂÉè</p>
                        </div>

                        <!-- 2. Basic Info Card -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] overflow-hidden mb-6">
                            <!-- Row 1: Name -->
                            <div class="flex justify-between items-center p-4 border-b border-black">
                                <label class="font-bold text-black text-sm w-20">ÂßìÂêç</label>
                                <input type="text" id="user-settings-name" placeholder="‰Ω†ÁöÑÂêçÂ≠ó" style="background-color: transparent !important;" 
                                       class="flex-1 text-right outline-none border-none bg-transparent text-gray-800 placeholder-gray-400 appearance-none focus:ring-0">
                            </div>

                            <!-- Row 2: Gender -->
                            <div class="flex justify-between items-center p-4 border-b border-black">
                                <label class="font-bold text-black text-sm w-20">ÊÄßÂà´</label>
                                <div class="flex items-center gap-2 flex-1 justify-end">
                                     <select id="user-settings-gender" class="text-right outline-none border-none bg-transparent text-gray-800 appearance-none pr-6 relative z-10 w-full focus:ring-0" style="direction: rtl;">
                                        <option value="">‰øùÂØÜ</option>
                                        <option value="Â•≥">Â•≥</option>
                                        <option value="Áî∑">Áî∑</option>
                                     </select>
                                </div>
                            </div>

                            <!-- Row 3: Birthday -->
                            <div class="flex justify-between items-center p-4">
                                <label class="font-bold text-black text-sm w-12">ÁîüÊó•</label>
                                <div class="flex items-center gap-2 flex-1 justify-end">
                                    <!-- Solar Input (Date Picker) -->
                                    <input type="date" id="user-settings-birthday-solar" style="background-color: transparent !important;" class="text-right outline-none border-none bg-transparent text-gray-800 text-sm w-32 focus:ring-0 appearance-none">
                                    
                                    <!-- Lunar Input (Text) - Initially Hidden -->
                                    <input type="text" id="user-settings-birthday-lunar" style="background-color: transparent !important;" placeholder="‰æãÂ¶Ç: ÂÜúÂéÜÂÖ´ÊúàÂçÅ‰∫î" class="text-right outline-none border-none bg-transparent text-gray-800 text-sm w-40 focus:ring-0 appearance-none hidden">

                                    <!-- Toggle Switch for Solar/Lunar -->
                                    <div class="relative inline-flex items-center cursor-pointer ml-2 select-none" onclick="toggleCalendarType()">
                                        <input type="hidden" id="user-birthday-type" value="solar"> <!-- Hidden input to store value -->
                                        <div class="w-14 h-7 bg-black rounded-full flex items-center px-1 transition-all duration-300 relative" id="calendar-toggle-bg">
                                            <!-- Moving dot -->
                                            <div class="w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-300 translate-x-0 absolute left-1" id="calendar-toggle-dot"></div>
                                            <!-- Text Labels (Overlay) -->
                                            <span class="absolute left-7 text-[10px] text-white font-bold pointer-events-none transition-opacity duration-300" id="calendar-label-solar" style="opacity: 0;">ÂÜúÂéÜ</span>
                                            <span class="absolute left-2 text-[10px] text-white font-bold pointer-events-none transition-opacity duration-300" id="calendar-label-lunar" style="opacity: 1;">Èò≥ÂéÜ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Persona Textarea -->
                        <div class="bg-white border border-black rounded-3xl shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] p-5 flex flex-col h-48 mb-6 relative">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-black text-sm">ÊàëÁöÑËÆæÂÆö</label>
                                <!-- <span class="text-xs text-gray-400">AIÂ∞ÜÊ†πÊçÆÊ≠§ËÆæÂÆö‰∏é‰Ω†ÂØπËØù</span> -->
                            </div>
                            <textarea id="user-persona-setting" style="background-color: transparent !important;" 
                                      class="flex-1 w-full outline-none resize-none bg-transparent text-sm leading-relaxed text-gray-800 placeholder-gray-400"
                                      placeholder="Âú®ËøôÈáåËæìÂÖ•‰Ω†ÁöÑËØ¶ÁªÜ‰∫∫ËÆæ..."></textarea>
                        </div>

                    </div>

                    <!-- 4. Bottom Actions (Fixed at bottom) -->
                    <div class="absolute bottom-0 left-0 w-full px-6 pb-8 pt-6 bg-gradient-to-t from-gray-50 via-gray-50 to-transparent">
                        <div class="flex gap-4">
                            <button class="flex-1 h-12 bg-black text-white rounded-full font-bold text-sm hover:opacity-80 transition-opacity shadow-lg"
                                    onclick="saveUserPersona()">
                                ‰øùÂ≠ò
                            </button>
                            <button class="flex-1 h-12 bg-black text-white rounded-full font-bold text-sm hover:opacity-80 transition-opacity shadow-lg"
                                     id="btn-save-user-preset"
                                     onclick="saveUserPersonaPreset()">
                                Â≠ò‰∏∫È¢ÑËÆæ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- D. ËÉåÊôØËÆæÁΩÆÂºπÁ™ó (Ê†∑Âºè‰øÆÂ§çÁâàÔºöÂ∏¶Â±Ö‰∏≠ÊñáÂ≠ó„ÄÅFlexÂ∏ÉÂ±Ä) -->
                <div id="bg-setting-modal" class="modal-layer" style="display: none; background: #fff;">
                    <div class="modal-header-bar" style="padding-top: 40px;">
                        <div class="modal-close-icon" onclick="closeSubModal('bg-setting-modal')">‚Äπ</div>
                        <div class="modal-title">ËÅäÂ§©ËÉåÊôØ</div>
                        <div class="modal-placeholder"></div>
                    </div>
                    <div class="creator-body" style="text-align: center;">

                        <!-- ÊºÇ‰∫ÆÁöÑÈ¢ÑËßàÊ°Ü -->
                        <div class="bg-preview-box" id="bg-preview-box"
                            style="height: 300px; background-color: #eee; margin: 20px; border-radius: 10px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #999;">
                            ÂΩìÂâçËÉåÊôØÈ¢ÑËßà
                        </div>

                        <input type="file" id="bg-file-input" hidden onchange="previewChatBg(this)">

                        <div class="creator-footer-btns">
                            <button class="cancel-btn-large"
                                onclick="document.getElementById('bg-file-input').click()">‰∏ä‰º†ÂõæÁâá</button>
                            <button class="save-btn-large" onclick="saveChatBg()">‰øùÂ≠òËÉåÊôØ</button>
                        </div>

                        <button class="text-btn" onclick="resetChatBg()"
                            style="margin-top:15px; color: red; background:none; border:none;">ÊÅ¢Â§çÈªòËÆ§ËÉåÊôØ</button>
                    </div>
                </div>

                <!-- E. ËÆ∞ÂøÜÊ°£Ê°à (ÂÖ®Â±èÊ°£Ê°àÊü•ÈòÖÈù¢ÊùøÔºöSocial Profile È£éÊ†º) -->
                <div id="memory-archive-modal" class="modal-layer" style="display: none; background: #fff;">
                    <!-- ÂÖ≥Èó≠ÊåâÈíÆ -->
                    <div class="modal-close-icon" onclick="closeMemoryArchiveModal()" style="position: absolute; top: 20px; right: 20px; z-index: 10; color: #000; font-size: 28px; cursor: pointer;">√ó</div>

                    <div class="memory-archive-container" style="width: 100%; height: 100%; overflow-y: auto; background: #fff; display: flex; flex-direction: column;">
                        
                        <!-- 1. Top Section: Identity -->
                        <div class="flex flex-col items-center pt-8 pb-4" style="display: flex; flex-direction: column; align-items: center; padding-top: 2rem; padding-bottom: 1rem;">
                            <img id="memory-archive-avatar" class="w-24 h-24 rounded-full object-cover bg-gray-200" src="" alt="Avatar" style="width: 6rem; height: 6rem; border-radius: 9999px; object-fit: cover; background-color: #e5e7eb;">
                            <div id="memory-archive-name" class="mt-4 font-bold text-xl text-black" style="margin-top: 1rem; font-weight: 700; font-size: 1.25rem; color: #000;">Name</div>
                        </div>

                        <!-- 2. Stats Section -->
                        <div class="flex justify-center gap-12 my-6" style="display: flex; justify-content: center; gap: 3rem; margin-top: 1.5rem; margin-bottom: 1.5rem;">
                            <div class="flex flex-col items-center" style="display: flex; flex-direction: column; align-items: center;">
                                <span class="text-xl font-bold text-black" id="stat-days" style="font-size: 1.25rem; font-weight: 700; color: #000;">0</span>
                                <span class="text-xs text-gray-500" style="font-size: 0.75rem; color: #6b7280;">days</span>
                            </div>
                            <div class="flex flex-col items-center" style="display: flex; flex-direction: column; align-items: center;">
                                <span class="text-xl font-bold text-black" id="stat-messages" style="font-size: 1.25rem; font-weight: 700; color: #000;">0</span>
                                <span class="text-xs text-gray-500" style="font-size: 0.75rem; color: #6b7280;">Êù°</span>
                            </div>
                            <div class="flex flex-col items-center" style="display: flex; flex-direction: column; align-items: center;">
                                <span class="text-xl font-bold text-black" id="stat-tokens" style="font-size: 1.25rem; font-weight: 700; color: #000;">0</span>
                                <span class="text-xs text-gray-500" style="font-size: 0.75rem; color: #6b7280;">Â≠ó</span>
                            </div>
                        </div>

                        <!-- 3. Divider & Title -->
                        <div class="mx-auto px-6 py-1 rounded-full bg-black text-white w-max text-sm font-bold tracking-wide mb-6" style="margin-left: auto; margin-right: auto; padding: 0.25rem 1.5rem; border-radius: 9999px; background-color: #000; color: #fff; width: max-content; font-size: 0.875rem; font-weight: 700; letter-spacing: 0.025em; margin-bottom: 1.5rem;">
                            MEMORY
                        </div>

                        <!-- 4. Tab Navigation -->
                        <div class="w-full border-b border-gray-200 mt-6 sticky top-0 bg-white z-10" style="width: 100%; border-bottom: 1px solid #e5e7eb; margin-top: 1.5rem; position: sticky; top: 0; background-color: #fff; z-index: 10;">
                            <div class="grid grid-cols-3 text-center" style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); text-align: center;">
                                <div class="memory-tab-item py-3 cursor-pointer text-gray-400" data-key="likes" onclick="switchMemoryArchiveTab('likes')" style="padding-top: 0.75rem; padding-bottom: 0.75rem; cursor: pointer; color: #9ca3af;">ÂñúÂ•Ω</div>
                                <div class="memory-tab-item py-3 cursor-pointer text-gray-400" data-key="habits" onclick="switchMemoryArchiveTab('habits')" style="padding-top: 0.75rem; padding-bottom: 0.75rem; cursor: pointer; color: #9ca3af;">‰π†ÊÉØ</div>
                                <div class="memory-tab-item py-3 cursor-pointer text-gray-400" data-key="events" onclick="switchMemoryArchiveTab('events')" style="padding-top: 0.75rem; padding-bottom: 0.75rem; cursor: pointer; color: #9ca3af;">Êàë‰ª¨</div>
                            </div>
                        </div>

                        <!-- 5. Main Content Area -->
                        <div class="memory-content-area p-4 pb-20" style="padding: 1rem; padding-bottom: 5rem; flex: 1;">
                            <!-- Input area for adding new memories -->
                            <div class="memory-archive-editor mb-4" style="border: 1px dashed #ccc; padding: 10px; border-radius: 8px; margin-bottom: 1rem;">
                                <textarea id="memory-archive-input" placeholder="Ê∑ªÂä†Êñ∞ËÆ∞ÂøÜ..." style="width: 100%; border: none; outline: none; resize: none; background: transparent; font-size: 14px; min-height: 40px; font-family: inherit;"></textarea>
                                <div class="flex justify-end mt-2" style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
                                    <button onclick="addMemoryArchiveItem()" style="background: #000; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 12px; border: none; cursor: pointer;">Add</button>
                                </div>
                            </div>

                            <div id="memory-archive-text" class="space-y-3" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <!-- List items will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>


                <!-- ÈïøÊåâËèúÂçï‰ΩìÁ≥ª -->
                <!-- 1. ÂÖ®Â±èÈÅÆÁΩ© (ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÂÖ≥Èó≠) -->
                <div id="context-menu-mask" onclick="closeContextMenu()"></div>

                <!-- 2. ËèúÂçïÊú¨‰Ωì -->
                <div id="msg-context-menu">
                    <div class="menu-grid">
                        <!-- Á¨¨‰∏ÄË°å -->
                        <div class="menu-item" onclick="menuAction('edit')">
                            <div class="menu-icon"><i class='bx bx-edit-alt'></i></div>
                            <div>ÁºñËæë</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('copy')"> <!-- Ë°•ÂÖÖ‰∏Ä‰∏™Â§çÂà∂ÔºåÂæàÂ∏∏Áî® -->
                            <div class="menu-icon"><i class='bx bx-copy'></i></div>
                            <div>Â§çÂà∂</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('quote')">
                            <div class="menu-icon"><i class='bx bx-quote-left'></i></div>
                            <div>ÂºïÁî®</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('trans')">
                            <div class="menu-icon"><i class='bx bx-globe'></i></div>
                            <div>ÁøªËØë</div>
                        </div>

                        <!-- Á¨¨‰∫åË°å -->
                        <div class="menu-item" onclick="menuAction('delete')">
                            <div class="menu-icon"><i class='bx bx-trash'></i></div>
                            <div>Âà†Èô§</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('forward')">
                            <div class="menu-icon"><i class='bx bx-share'></i></div>
                            <div>ËΩ¨Âèë</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('fav')">
                            <div class="menu-icon"><i class='bx bx-star'></i></div>
                            <div>Êî∂Ëóè</div>
                        </div>
                        <div class="menu-item" onclick="menuAction('multi')">
                            <div class="menu-icon"><i class='bx bx-list-check'></i></div>
                            <div>Â§öÈÄâ</div>
                        </div>
                        <!-- ÊèêÈÜíÊîæ‰∏ç‰∏ã‰∫ÜÔºåÂæÆ‰ø°‰∏ÄËà¨ÊòØÂêëÂè≥ÁøªÈ°µÔºåËøôÈáåÂÖà‰∏çÊîæÊàñËÄÖÊõøÊç¢Êéâ‰∏äÈù¢Êüê‰∏™ -->
                    </div>
                </div>

            </div>
            <!-- ========== „ÄêËÅäÂ§©Â§ßÁõíÂ≠êÁªìÊùü„Äë ========== -->


        </div>
        <div class="home-indicator"></div>
    </div>

    <!-- ÈÄöÁî®Êñá‰ª∂‰∏ä‰º†ËæìÂÖ•Ê°Ü (Â§çÁî®) -->
    <input type="file" id="global-uploader" accept="image/*" style="display:none;">


    <input type="file" id="wallpaper-uploader" accept="image/*" style="display:none;">

    <!-- === Êñ∞Â¢ûÔºöËΩ¨ÂèëËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂºπÁ™ó === -->
    <div id="forward-modal" class="modal-layer">
        <div class="forward-box">
            <div class="forward-header">
                <span>ÈÄâÊã©ÂèëÈÄÅÁªô...</span>
                <span class="close-btn" onclick="closeForwardModal()">√ó</span>
            </div>

            <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®ÂÆπÂô® -->
            <div id="forward-contact-list" class="forward-list">
                <!-- JS‰ºöËá™Âä®Â°´ÂÖÖËøôÈáå -->
            </div>
        </div>
    </div>
    <!-- ÂºïÂÖ•Â§ßÂÆπÈáèÂ≠òÂÇ®Â∫ì localForage - ‰ΩøÁî®BootCDN -->
    <!-- ÊõøÊç¢ÊéâÂéüÊù•ÁöÑ bootcdn ÈìæÊé•ÔºåÊîπÁî®Ëøô‰∏™ -->
    <script src="https://unpkg.com/localforage@1.10.0/dist/localforage.min.js"></script>

    <!-- 1. ÂºïÂÖ•AppÈÄªËæë -->
    <script src="JS/apps.js"></script>
    <!-- Êñ∞Â¢ûÔºöËÅäÂ§©‰∏ìÁî®ÈÄªËæë -->
    <script src="JS/api.js"></script>
    <script src="JS/chat.js"></script>
    <script src="JS/chat-settings.js"></script>
    <script src="JS/moments.js"></script>
    <script src="JS/ÊàëÁöÑ/profile.js"></script>
    <script src="JS/ÊàëÁöÑ/core.js"></script>
    <script src="JS/worldbook.js?v=2"></script>

    <!-- 2. ÂºïÂÖ• ÊäÄËÉΩÊï∞ÊçÆÈÄªËæë -->
    <script src="JS/widgets.js"></script>
    <script src="JS/slider.js"></script>
    <script src="JS/appearance.js"></script>
    <script src="JS/settings.js"></script>
    <!-- 3. ÂºïÂÖ• ÊÄªÁ≥ªÁªü ÁöÑÈÄªËæë (ÂøÖÈ°ªÂºïÂÖ•Ëøô‰∏™ÔºåÊåâÈíÆÊâç‰ºöÊúâÂèçÂ∫îÔºÅ) -->
    <script src="JS/system.js"></script>
    <script>
        /* =========================================================
           Service Worker Ê≥®ÂÜåÈÄªËæë (ÂøÖÈ°ªÂä†Ëøô‰∏™ÊâçËÉΩÂÆâË£ÖÂà∞Ê°åÈù¢ÔºÅ)
           ========================================================= */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ ServiceWorker Ê≥®ÂÜåÊàêÂäü: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('‚ùå ServiceWorker Ê≥®ÂÜåÂ§±Ë¥•: ', err);
                    });
            });
        }

        /* =========================================================
           ÂºÄÂ±èÂä®ÁîªÈÄªËæë
           ========================================================= */
        window.addEventListener('load', function () {
            const splashScreen = document.getElementById('splash-screen');
            const hasVisited = localStorage.getItem('has_visited_shubao_phone');

            if (hasVisited) {
                // Â∑≤ÁªèËÆøÈóÆËøáÔºåÂø´ÈÄüË∑≥ËøáÂä®Áîª
                if (splashScreen) {
                    splashScreen.style.display = 'none';
                }
            } else {
                // È¶ñÊ¨°ËÆøÈóÆÔºåÊòæÁ§∫ÂÆåÊï¥Âä®Áîª
                setTimeout(() => {
                    if (splashScreen) {
                        splashScreen.classList.add('fade-out');
                        setTimeout(() => {
                            splashScreen.style.display = 'none';
                            // Ê†áËÆ∞Â∑≤ËÆøÈóÆ
                            localStorage.setItem('has_visited_shubao_phone', 'true');
                        }, 500); // Á≠âÂæÖÊ∑°Âá∫Âä®ÁîªÂÆåÊàê
                    }
                }, 2000); // ÊòæÁ§∫2Áßí
            }

            // 1. ÂêØÂä®Â§ñËßÇÊÅ¢Â§ç (Â£ÅÁ∫∏„ÄÅAppÂõæÊ†á)
            if (window.initDesktopState) {
                window.initDesktopState();
            } else {
                setTimeout(() => window.initDesktopState && window.initDesktopState(), 100);
            }

            // 2. ÂêØÂä®ÁªÑ‰ª∂ÊÅ¢Â§ç (ÁªÑ‰ª∂ÂõæÁâá)
            if (window.initWidgetState) {
                window.initWidgetState();
            } else {
                setTimeout(() => window.initWidgetState && window.initWidgetState(), 100);
            }

        }); // ÁªìÊùü window load
    </script>
    <script>
        // === ÈÄöÁî®ÂõæÁâá‰∏ä‰º†Â§ÑÁêÜÂô® ===
        // 1. ÂÆö‰πâ‰∏Ä‰∏™ÂèòÈáèËÆ∞ÂΩïÂΩìÂâçÊ≠£Âú®Êìç‰ΩúÂì™‰∏™ÂÖÉÁ¥† ID
        window.currentUploadTargetId = '';

        // 2. ÁÇπÂáªÁªÑ‰ª∂Êó∂Ë∞ÉÁî®ÁöÑÂáΩÊï∞
        function triggerWidgetUpload(imgId) {
            window.currentUploadTargetId = 'img-' + imgId;
            window.currentEditingAppIndex = -1;
            window.activeImgId = null;
            window.activeHintId = null;
            document.getElementById('global-uploader').click();
        }

        // 4. È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çÂõæÁâá
        function restoreWidgetImages() {
            const widgetIds = ['img-sticker-1', 'img-sticker-2', 'img-top-right-banner', 'img-aesthetic-photo', 'img-aesthetic-bg', 'img-main-widget'];
            widgetIds.forEach(id => {
                if (window.localforage) {
                    if (window.DB && typeof DB.configLargeStore === 'function') {
                        DB.configLargeStore();
                    }
                    localforage.getItem('widget_img_' + id).then(function (savedData) {
                        if (savedData) {
                            const imgEl = document.getElementById(id);
                            if (imgEl) {
                                imgEl.src = savedData;
                                imgEl.style.opacity = '1';
                                if (imgEl.style.display === 'none') {
                                    imgEl.style.display = 'block';
                                }
                                if (imgEl.previousElementSibling && imgEl.previousElementSibling.classList && imgEl.previousElementSibling.classList.contains('main-widget-placeholder')) {
                                    imgEl.previousElementSibling.style.display = 'none';
                                }
                                if (imgEl.nextElementSibling && imgEl.nextElementSibling.classList && imgEl.nextElementSibling.classList.contains('upload-hint-text')) {
                                    imgEl.nextElementSibling.style.display = 'none';
                                }
                            }
                        }
                    });
                } else {
                    const savedData = localStorage.getItem('widget_save_' + id);
                    if (savedData) {
                        const imgEl = document.getElementById(id);
                        if (imgEl) {
                            imgEl.src = savedData;
                            imgEl.style.opacity = '1';
                            if (imgEl.style.display === 'none') {
                                imgEl.style.display = 'block';
                            }
                            if (imgEl.previousElementSibling && imgEl.previousElementSibling.classList && imgEl.previousElementSibling.classList.contains('main-widget-placeholder')) {
                                imgEl.previousElementSibling.style.display = 'none';
                            }
                            if (imgEl.nextElementSibling && imgEl.nextElementSibling.classList && imgEl.nextElementSibling.classList.contains('upload-hint-text')) {
                                imgEl.nextElementSibling.style.display = 'none';
                            }
                        }
                    }
                }
            });
        }

        // 5. Á´ãÂç≥ÊâßË°åÊÅ¢Â§ç
        window.addEventListener('load', restoreWidgetImages);
    </script>

    <script>
        // === INSÂç°ÁâáÂäüËÉΩÈÄªËæë (Êï¥ÂêàÁâà) ===

        // 1. ÂÆûÊó∂Êõ¥Êñ∞Âç°ÁâáÈ°∂ÈÉ®Êó∂Èó¥
        function updateAesTime() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const timeString = `${hours}:${minutes} ${ampm}`;

            const timeEl = document.getElementById('aes-live-time');
            if (timeEl) timeEl.innerText = timeString;
        }
        setInterval(updateAesTime, 1000); // ÊØèÁßíÂà∑Êñ∞
        updateAesTime(); // Á´ãÂç≥ÊâßË°å

        // 2. ‰øùÂ≠òÊ∞îÊ≥°ÊñáÊ°à
        function saveAesText() {
            const textEl = document.getElementById('aes-editable-text');
            if (textEl) {
                localStorage.setItem('aes_bubble_text', textEl.innerText);
            }
        }

        // 3. È°µÈù¢Âä†ËΩΩÊó∂ÊÅ¢Â§çÊñáÊ°à
        window.addEventListener('load', function () {
            const savedText = localStorage.getItem('aes_bubble_text');
            const textEl = document.getElementById('aes-editable-text');
            if (savedText && textEl) {
                textEl.innerText = savedText;
            }
        });
    </script>

</body>

</html>
